# class-diagram-analyst â€” Architecture Design

> Generated by Skill Architect | Date: 2026-02-20
> Status: ğŸŸ¡ PHASE 1-2 CONFIRMED â€” Phase 3 Ready to Build

---

## 0. Input Mechanism

> **Thay Ä‘á»•i cÆ¡ cháº¿ so vá»›i thiáº¿t káº¿ ban Ä‘áº§u**: Skill khÃ´ng chá»‰ cháº¡y theo module cá»‘ Ä‘á»‹nh.
> Skill nháº­n **yÃªu cáº§u mÆ¡ há»“ hoáº·c chÆ°a Ä‘á»§ rÃµ rÃ ng tá»« ngÆ°á»i dÃ¹ng + file context Ä‘Ã­nh kÃ¨m**,
> sau Ä‘Ã³ tá»± phÃ¢n tÃ­ch Ä‘á»ƒ xÃ¡c Ä‘á»‹nh scope trÆ°á»›c khi báº¯t Ä‘áº§u.

### 0.1 Input Types Ä‘Æ°á»£c cháº¥p nháº­n

| Loáº¡i Input | VÃ­ dá»¥ | Skill xá»­ lÃ½ tháº¿ nÃ o |
|-----------|-------|--------------------|
| **YÃªu cáº§u module rÃµ rÃ ng** | "Váº½ class diagram M1" | Cháº¡y tháº³ng Phase A vá»›i module Ä‘Ã£ biáº¿t |
| **YÃªu cáº§u theo chá»©c nÄƒng** | "Váº½ class cho chá»©c nÄƒng Ä‘Äƒng kÃ½" | PhÃ¢n tÃ­ch â†’ map sang entity/module â†’ há»i confirm |
| **YÃªu cáº§u mÆ¡ há»“** | "Cáº§n thiáº¿t káº¿ schema cho notifications" | PhÃ¢n tÃ­ch intent â†’ propose scope â†’ CHá»œ confirm trÆ°á»›c khi lÃ m |
| **YÃªu cáº§u + file Ä‘Ã­nh kÃ¨m** | "Dá»±a vÃ o file nÃ y, váº½ class diagram" + attach file | Äá»c file context â†’ extract entity hints â†’ merge vá»›i ER Diagram |
| **YÃªu cáº§u partial update** | "ThÃªm field avatar vÃ o User class" | Identify affected entity â†’ update class-mX.md + re-lock YAML |

### 0.2 Input Resolution Flow

```mermaid
flowchart TD
    Input([User Input]) --> DetectType{PhÃ¢n loáº¡i
input?}

    DetectType -->|Module rÃµ, VD: M1| DirectRun[Cháº¡y tháº³ng Phase A
vá»›i module Ä‘Ã£ biáº¿t]
    DetectType -->|Chá»©c nÄƒng chÆ°a map| AnalyzeFeature[PhÃ¢n tÃ­ch intent
map sang entity + module]
    DetectType -->|File Ä‘Ã­nh kÃ¨m| ReadContext[Äá»c file context
extract entity hints]
    DetectType -->|MÆ¡ há»“, thiáº¿u thÃ´ng tin| AskClarify[Há»i lÃ m rÃµ:
Module nÃ o? Entity nÃ o?]

    ReadContext --> MergeER[Merge vá»›i er-diagram.md
Uu tiÃªn ER náº¿u conflict]
    AnalyzeFeature --> ProposeScope[Äá» xuáº¥t scope:
Entities + Module + Reason]
    ProposeScope --> IP0{IP0: Confirm scope}

    IP0 -->|Confirmed| DirectRun
    IP0 -->|Adjusted| ProposeScope
    AskClarify -->|User tráº£ lá»i| DetectType
    MergeER --> ProposeScope
    DirectRun --> PhaseA[Phase A: Extract Entities]

    style IP0 fill:#fff3e0,stroke:#ef6c00
    style AskClarify fill:#e3f2fd,stroke:#1565c0
    style ReadContext fill:#f3e5f5,stroke:#7b1fa2
```

### 0.3 File Context Rules

Khi user Ä‘Ã­nh kÃ¨m file context (specification, note, previous diagram):

1. **Äá»c file context TRÆ¯á»šC** â€” extract táº¥t cáº£ entity/field/behavior hints
2. **Cross-reference vá»›i `er-diagram.md`** â€” ER lÃ  nguá»“n chÃ¢n lÃ½, file context lÃ  bá»• sung
3. **Conflict resolution**: Náº¿u file context mÃ´ táº£ field khÃ´ng cÃ³ trong ER â†’ Mark `[FROM_CONTEXT]`, khÃ´ng pháº£i `[ASSUMPTION]`
4. **Traceability**: Source citation ghi rÃµ `"context-file.md#section"` thay vÃ¬ ER
5. **BÃ¡o cÃ¡o delta**: Sau khi Ä‘á»c file context, bÃ¡o cÃ¡o cho user: "TÃ¬m tháº¥y X entities, Y fields má»›i khÃ´ng cÃ³ trong ER"

### 0.4 Interaction Point 0 (IP0) â€” Input Clarification Gate

> ÄÃ¢y lÃ  **gate má»›i** Ä‘Æ°á»£c thÃªm vÃ o khi input chÆ°a Ä‘á»§ rÃµ rÃ ng.
> IP0 chá»‰ kÃ­ch hoáº¡t khi input type lÃ  **mÆ¡ há»“** hoáº·c **chá»©c nÄƒng chÆ°a map**.

```
IP0 Output â€” Skill pháº£i trÃ¬nh bÃ y:
  âœ… TÃ´i hiá»ƒu yÃªu cáº§u cá»§a yÃªu thÆ°Æ¡ng lÃ : [paraphrase láº¡i]
  âœ… Scope tÃ´i Ä‘á» xuáº¥t: [Module X â†’ Entities: A, B, C]
  âœ… Nguá»“n tÃ´i sáº½ dÃ¹ng: [er-diagram.md + activity-diagrams/mX + UseCase/mX]
  â“ XÃ¡c nháº­n Ä‘á»ƒ tiáº¿p tá»¥c?
```

---

## 1. Problem Statement

### Bá»‘i cáº£nh

Dá»± Ã¡n KLTN Ä‘ang á»Ÿ **Life-2 (Thiáº¿t káº¿)** trong chuá»—i sáº£n xuáº¥t tri thá»©c:

```
Life-1 (Requirements) â†’ Life-2 (Design) â†’ Life-3 (Code)
```

File `Docs/life-2/diagrams/class-diagrams/class-diagram.md` hiá»‡n chá»‰ lÃ 
**placeholder vá»›i 2 class (User + Post)** â€” khÃ´ng Ä‘á»§ Ä‘á»ƒ phá»¥c vá»¥ AI Code Agent
á»Ÿ Life-3.

### Pain Point

| Váº¥n Ä‘á» | Há»‡ quáº£ |
|--------|--------|
| ER Diagram cÃ³ ~12 entities nhÆ°ng chÆ°a cÃ³ OOP view | AI Code Agent khÃ´ng biáº¿t field nÃ o cÃ³ Method, Hook, Validate rule |
| KhÃ´ng cÃ³ Access Control trÃªn Class level | AI sinh code thiáº¿u RBAC, bá» qua phÃ¢n quyá»n |
| KhÃ´ng cÃ³ nguá»“n trÃ­ch dáº«n (citation) cho má»—i field | AI dá»… hallucinate thÃªm field khÃ´ng tá»“n táº¡i trong spec |
| ToÃ n dá»± Ã¡n 1 file class duy nháº¥t | Context quÃ¡ lá»›n â†’ AI bá»‹ máº¥t context khi xá»­ lÃ½ cuá»‘i file |
| KhÃ´ng cÃ³ machine-readable contract | Skill 2.6 (Schema Design) khÃ´ng cÃ³ ground truth Ä‘á»ƒ Ä‘á»c |

### Má»¥c tiÃªu Skill

`class-diagram-analyst` lÃ  **Skill 2.5** â€” sinh tÃ i liá»‡u Class Diagram theo chuáº©n
dual-format (Mermaid + YAML Contract), **per-module**, Ä‘á»§ chi tiáº¿t Ä‘á»ƒ:

1. **Human Review**: Analyst review báº±ng file `.md` (Mermaid classDiagram)
2. **AI Machine Input**: Skill 2.6 Ä‘á»c file `.yaml` (YAML Contract â€” LOCKED)
3. **Chá»‘ng hallucination**: Má»i field Ä‘á»u pháº£i cÃ³ source citation tá»« tÃ i liá»‡u gá»‘c

### Pipeline Position

```
ER Diagram + UseCase + Activity + Sequence
         â†“
   [SKILL 2.5 â€” class-diagram-analyst]  â† Skill nÃ y
         â†“
   class-mX.md (human)  +  class-mX.yaml (AI contract)
         â†“
   [SKILL 2.6 â€” schema-design-analyst]  â†’ schema-design/*.md
         â†“
   AI Code Agent (Life-3) Ä‘á»c schema specs
```

---

## 2. Capability Map

### 2.1 Tri thá»©c (Knowledge)

| Tri thá»©c | Nguá»“n | Quan trá»ng |
|----------|-------|------------|
| MongoDB Modeling Patterns | `knowledge/mongodb-patterns.md` | â­â­â­ |
| PayloadCMS Field Types & API | `knowledge/payload-types.md` | â­â­â­ |
| Mermaid classDiagram Syntax | `knowledge/mermaid-rules.md` | â­â­â­ |
| Aggregate Root Strategy | Embedded trong mongodb-patterns | â­â­â­ |
| Entity Dictionary (12 entities) | `er-diagram.md` | â­â­â­ |
| Behaviors per Entity | `activity-diagrams/m*-a*.md` | â­â­â­ |
| Access Rules per Actor | `UseCase/use-case-m*.md` | â­â­â­ |
| Method signatures | `sequence-diagrams/detailed-m*.md` | â­â­ |

### 2.2 Quy trÃ¬nh (Process)

Skill thá»±c thi theo **6 phases, 3 interaction points**, má»—i module Ä‘á»™c láº­p:

```
Phase A  â†’  Phase B  â†’  Phase C  â†’  [IP1]  â†’  Phase D  â†’  [IP2]  â†’  Phase E  â†’  Phase F  â†’  [IP3]
Extract     CrossRef     Classify   Confirm    Gen .md    Review     Gen .yaml   Validate    Done
```

**Chi tiáº¿t:**

- **Phase A â€” Extract Entities**: Äá»c `er-diagram.md`, láº¥y entity list + full field dict cho module hiá»‡n táº¡i
- **Phase B â€” Cross-Reference**: Grep `activity-diagrams/` tÃ¬m Hook/Behavior; grep `UseCase/` tÃ¬m Access Rule
- **Phase C â€” Classify**: Quyáº¿t Ä‘á»‹nh má»—i entity lÃ  `Aggregate Root` hay `Embedded Doc` theo decision tree
- **[IP1] Confirm Entity List**: TrÃ¬nh bÃ y danh sÃ¡ch entities + phÃ¢n loáº¡i â†’ CHá»œ user xÃ¡c nháº­n
- **Phase D â€” Generate Markdown**: Sinh `class-mX.md` vá»›i Mermaid classDiagram + Traceability Table
- **[IP2] Review Markdown**: TrÃ¬nh bÃ y file.md â†’ CHá»œ user review vÃ  approve
- **Phase E â€” Generate YAML**: Chuyá»ƒn Ä‘á»•i .md thÃ nh YAML Contract (locked format)
- **Phase F â€” Self-Validate**: Cháº¡y validate logic (citation check, type check, slug unique)
- **[IP3] Report Result**: BÃ¡o cÃ¡o káº¿t quáº£ validation â†’ DONE náº¿u pass, BLOCK náº¿u fail

### 2.3 Kiá»ƒm soÃ¡t (Guardrails)

| Rule | HÃ nh Ä‘á»™ng vi pháº¡m |
|------|------------------|
| Má»i field PHáº¢I cÃ³ `source:` citation | BLOCK â€” khÃ´ng ghi file |
| Field type pháº£i náº±m trong `allowed-types.json` | BLOCK â€” throw error |
| KhÃ´ng Ä‘Æ°á»£c duplicate entity slug | BLOCK â€” throw error |
| Field khÃ´ng cÃ³ nguá»“n trong ER/Activity/UseCase | Mark `[ASSUMPTION]`, alert user |
| YAML Contract khÃ´ng Ä‘Æ°á»£c edit thá»§ cÃ´ng | Comment rÃµ trong file header |
| Pháº£i CHá»œ user confirm sau má»—i Interaction Point | KhÃ´ng bá» qua bÆ°á»›c nÃ o |
| Module Ä‘ang lÃ m pháº£i `âœ… Ready` trong index.md | Chá»‰ lock khi user approve |

---

## 3. Zone Mapping

| Zone | Ná»™i dung | Báº¯t buá»™c? |
|------|----------|-----------|
| **Core (SKILL.md)** | Persona: Class Structure Analyst; 6-phase workflow; 3 interaction points; guardrails | âœ… |
| **knowledge/** | `payload-types.md`, `mermaid-rules.md`, `mongodb-patterns.md` | âœ… Táº§ng 1 |
| **scripts/** | `extract_entities.py`, `validate_contract.py`, `generate_yaml.py` | âœ… |
| **templates/** | `class-module.md.template`, `contract.yaml.template` | âœ… |
| **data/** | `allowed-types.json`, `module-map.yaml` | âœ… |
| **loop/** | `checklist.md`, `phase-verify.md`, `test-cases/` | âœ… Má»—i phase |
| **assets/** | KhÃ´ng cáº§n | âŒ |

---

## 4. Folder Structure

```mermaid
mindmap
  root((class-diagram-analyst))
    SKILL.md
      Persona: Class Structure Analyst
      6 Phases
      Interaction Points x3
      Guardrails x7
    knowledge
      payload-types.md
        Field type whitelist
        Allowed constraints
        Payload config keys
      mermaid-rules.md
        classDiagram syntax
        Arrow conventions
        Stereotype labels
      mongodb-patterns.md
        Aggregate Root decision
        Embed vs Reference
        Computed Pattern
        Polymorphic Pattern
    scripts
      extract_entities.py
        Parse er-diagram.md
        Return entity + fields per module
      validate_contract.py
        Check citation count
        Check type whitelist
        Check slug unique
        Report assumptions
      generate_yaml.py
        Convert md to yaml
        Lock contract header
    templates
      class-module.md.template
        Mermaid classDiagram block
        Traceability Table
        Assumption Register
      contract.yaml.template
        meta section
        entities section
        behaviors section
        access_control section
        validation_report
    data
      allowed-types.json
        text email number boolean
        select relationship upload
        array group richText
      module-map.yaml
        M1 auth-profile entities
        M2 content-engine entities
        M3 discovery-feed entities
        M4 engagement entities
        M5 bookmarking entities
        M6 notifications entities
    loop
      checklist.md
        Per-field citation check
        Type validity check
        No duplicate slug
      phase-verify.md
        Phase A done?
        Cross-ref complete?
        IP confirmed?
      test-cases
        m1-test.md
        validate-contract-test.md
```

---

## 5. Execution Flow

### 5.1 Luá»“ng thá»±c thi tá»•ng quÃ¡t

```mermaid
sequenceDiagram
    participant U as USER
    participant S as Skill Agent
    participant ER as er-diagram.md
    participant AC as activity-diagrams/
    participant UC as UseCase/
    participant SC as scripts/
    participant OF as Output Files
    participant LZ as loop/checklist.md

    U->>S: "Váº½ class diagram [Module X]"
    S->>S: Boot: Äá»c SKILL.md + knowledge/ (táº§ng 1)

    Note over S: Phase A â€” Extract
    S->>ER: parse entity list + fields cho Module X
    S->>SC: extract_entities.py --module M1

    Note over S: Phase B â€” Cross-Reference
    S->>AC: grep behaviors, hooks, lifecycle cho entities M1
    S->>UC: grep access rules (actors, CRUD permissions)

    Note over S: Phase C â€” Classify
    S->>S: Cháº¡y Aggregate Root decision tree
    S->>S: GÃ¡n behaviors[] vÃ  access_control[] cho má»—i entity

    Note over S,U: [INTERACTION POINT 1] â€” Entity List Confirm
    S->>U: TrÃ¬nh bÃ y entity list + phÃ¢n loáº¡i + behaviors tÃ³m táº¯t
    U->>S: Confirm / Adjust entity list

    Note over S: Phase D â€” Generate Markdown
    S->>OF: Ghi class-mX.md (Mermaid classDiagram)
    S->>OF: Append Traceability Table (field â†’ source mapping)

    Note over S,U: [INTERACTION POINT 2] â€” Markdown Review
    S->>U: "Review class-mX.md. Approve Ä‘á»ƒ lock YAML?"
    U->>S: Approve / Request changes

    Note over S: Phase E â€” Generate YAML
    S->>SC: generate_yaml.py class-mX.md â†’ class-mX.yaml
    S->>OF: Ghi class-mX.yaml (LOCKED CONTRACT header)

    Note over S: Phase F â€” Self-Validate
    S->>SC: validate_contract.py class-mX.yaml
    S->>LZ: Cross-check vá»›i checklist.md

    alt Validation PASS
        S->>OF: Cáº­p nháº­t index.md â†’ Status = âœ… Ready
        S->>U: "âœ… LOCKED. class-mX.yaml sáºµn sÃ ng cho Skill 2.6"
    else Validation FAIL
        S->>U: "ğŸ”´ BLOCK: [danh sÃ¡ch vi pháº¡m]. Cáº§n fix trÆ°á»›c."
    end
```

### 5.2 Workflow theo Phase â€” Gating rÃµ rÃ ng

```mermaid
flowchart LR
    A[Phase A\nExtract Entities] -->|entities + fields| B
    B[Phase B\nCross-Reference\nBehavior + Access] -->|enriched entities| C
    C[Phase C\nClassify\nRoot vs Embed] -->|classified list| IP1

    IP1{ğŸ›‘ IP1\nConfirm\nEntity List} -->|User approved| D
    IP1 -->|Adjustments| C

    D[Phase D\nGen class-mX.md\nMermaid + Table] -->|md file| IP2

    IP2{ğŸ›‘ IP2\nReview .md\nApprove?} -->|Approved| E
    IP2 -->|Changes needed| D

    E[Phase E\nGen class-mX.yaml\nContract] -->|yaml file| F

    F[Phase F\nSelf-Validate\nvalidate_contract.py] -->|check result| IP3

    IP3{ğŸ›‘ IP3\nValidation\nPassed?} -->|PASS| Done
    IP3 -->|FAIL â†’ list violations| Fix

    Fix[Fix violations\nresource citation\ntype errors] --> E
    Done([âœ… LOCKED & READY\nUpdate index.md])

    style IP1 fill:#fff3e0,stroke:#ef6c00
    style IP2 fill:#fff3e0,stroke:#ef6c00
    style IP3 fill:#fff3e0,stroke:#ef6c00
    style Done fill:#e8f5e9,stroke:#2e7d32
    style Fix fill:#ffcdd2,stroke:#c62828
```

### 5.3 Decision Tree â€” Aggregate Root vs Embedded

```mermaid
flowchart TD
    Start([Entity tá»« ER Diagram]) --> Q1{Nhiá»u Collection\nFK trá» vÃ o entity?}

    Q1 -->|CÃ³| Root
    Q1 -->|KhÃ´ng| Q2{Entity cÃ³\nTimestamps riÃªng?}

    Q2 -->|CÃ³| Root
    Q2 -->|KhÃ´ng| Q3{Query entity\nnÃ y Ä‘á»™c láº­p?}

    Q3 -->|CÃ³| Root
    Q3 -->|KhÃ´ng| Q4{Size cÃ³ thá»ƒ\nvÆ°á»£t giá»›i háº¡n?}

    Q4 -->|CÃ³| Root
    Q4 -->|KhÃ´ng| Embed

    Root[âœ… AGGREGATE ROOT\nPayload Collection Ä‘á»™c láº­p]
    Embed[ğŸ“¦ EMBEDDED DOC\nNhÃºng vÃ o parent]

    Root --> BehaviorCheck{Activity Diagram
cÃ³ Hook?}
    BehaviorCheck -->|CÃ³| AddBehavior["ThÃªm behaviors list"]
    BehaviorCheck -->|KhÃ´ng| AccessCheck

    AddBehavior --> AccessCheck{UseCase cÃ³
Access Rule?}
    AccessCheck -->|CÃ³| AddAccess["ThÃªm access_control list"]
    AccessCheck -->|KhÃ´ng| CitationGate

    AddAccess --> CitationGate{Má»i field
cÃ³ source?}
    CitationGate -->|CÃ³| Output["âœ… Gen Markdown + YAML"]
    CitationGate -->|field thiáº¿u source| Assumption["âš ï¸ Mark ASSUMPTION
â†’ Alert user"]
    Assumption --> Output

    style Root fill:#e8f5e9,stroke:#2e7d32
    style Embed fill:#fff3e0,stroke:#ef6c00
    style Assumption fill:#fff9c4,stroke:#f9a825
    style Output fill:#e3f2fd,stroke:#1565c0
```

---

## 6. Interaction Points

| # | Thá»i Ä‘iá»ƒm | Ná»™i dung tÆ°Æ¡ng tÃ¡c | LÃ½ do |
|---|-----------|-------------------|-------|
| **IP1** | Sau Phase C (Classify) | TrÃ¬nh bÃ y danh sÃ¡ch entities, Root/Embed phÃ¢n loáº¡i, behaviors tÃ³m táº¯t | Pháº£i xÃ¡c nháº­n scope trÆ°á»›c khi gen file â€” sai á»Ÿ Ä‘Ã¢y sáº½ sai toÃ n bá»™ |
| **IP2** | Sau Phase D (Gen .md) | Hiá»ƒn thá»‹ `class-mX.md` Ä‘áº§y Ä‘á»§ â€” CHá»œ approve | NgÆ°á»i dÃ¹ng cáº§n review Mermaid diagram + Traceability Table trÆ°á»›c khi khÃ³a YAML |
| **IP3** | Sau Phase F (Validate) | BÃ¡o cÃ¡o káº¿t quáº£ validation: pass/fail + danh sÃ¡ch vi pháº¡m | KhÃ´ng Ä‘Æ°á»£c auto-lock YAML khi cÃ³ violation â€” pháº£i user aware |

> âš ï¸ **Quy táº¯c báº¥t biáº¿n**: KhÃ´ng bÆ°á»›c qua Interaction Point mÃ  khÃ´ng nháº­n pháº£n há»“i tá»« ngÆ°á»i dÃ¹ng.

---

## 7. Progressive Disclosure Plan

### Táº§ng 1: Báº¯t buá»™c Ä‘á»c khi skill khá»Ÿi Ä‘á»™ng (Mandatory)

```
- SKILL.md                         â† LuÃ´n Ä‘áº§u tiÃªn
- knowledge/payload-types.md       â† Biáº¿t field type nÃ o há»£p lá»‡ trÆ°á»›c khi lÃ m gÃ¬
- knowledge/mongodb-patterns.md    â† NguyÃªn táº¯c Aggregate Root / Embedded
- data/module-map.yaml             â† Biáº¿t module nÃ o cÃ³ entity nÃ o
- loop/checklist.md                â† Biáº¿t validation rule trÆ°á»›c khi báº¯t Ä‘áº§u
```

### Táº§ng 2: Tá»± quyáº¿t Ä‘á»‹nh theo context (Conditional)

```
Khi xá»­ lÃ½ Module X:
  - er-diagram.md                  â† Äá»c 1 láº§n Ä‘á»ƒ extract entities
  - activity-diagrams/mX-a*.md    â† Chá»‰ Ä‘á»c file cá»§a module Ä‘ang lÃ m
  - UseCase/use-case-mX-*.md      â† Chá»‰ Ä‘á»c use case cá»§a module Ä‘ang lÃ m
  - sequence-diagrams/detailed-mX.md  â† Chá»‰ khi cáº§n method signature

Khi gen output:
  - templates/class-module.md.template   â† Äá»c khi Phase D báº¯t Ä‘áº§u
  - templates/contract.yaml.template     â† Äá»c khi Phase E báº¯t Ä‘áº§u

Khi validate:
  - data/allowed-types.json              â† Äá»c trong Phase F
  - knowledge/mermaid-rules.md           â† Äá»c náº¿u cáº§n verify Mermaid syntax
```

---

## 8. Risks & Blind Spots

| # | Risk | Má»©c Ä‘á»™ | Mitigation |
|---|------|--------|------------|
| R1 | **AI hallucinate field** khÃ´ng cÃ³ trong ER | ğŸ”´ Cao | Guardrail: Má»i field pháº£i cÃ³ `source:` â€” khÃ´ng cÃ³ nguá»“n â†’ BLOCK |
| R2 | **Entity `shares`** tá»“n táº¡i trong ERD tá»•ng quan nhÆ°ng **khÃ´ng cÃ³ Entity Dictionary** | ğŸŸ  Trung | Mark `[ASSUMPTION]` + thiáº¿t káº¿ provisional fields cÆ¡ báº£n â†’ Alert user ngay IP1 |
| R3 | **Confusion Embed vs Root** vá»›i `tags`, `post_media` (join tables) | ğŸŸ  Trung | Decision Tree rÃµ rÃ ng (Â§5.3) + Module-map.yaml pre-classify |
| R4 | **Mermaid classDiagram syntax lá»—i** (unsupported operators) | ğŸŸ¡ Tháº¥p | `mermaid-rules.md` whitelist syntax + template cá»©ng |
| R5 | **Context loss khi file .md lá»›n** | ğŸŸ¡ Tháº¥p | Per-module chunking â€” max ~1 entity dict/file; index.md routing |
| R6 | **YAML Contract bá»‹ edit thá»§ cÃ´ng** sau khi lock | ğŸŸ¡ Tháº¥p | Header comment rÃµ `âš ï¸ DO NOT EDIT MANUALLY. Generated by Skill 2.5.` |
| R7 | **Access Control khÃ´ng Ä‘áº§y Ä‘á»§** náº¿u bá» qua UseCase | ğŸŸ  Trung | Cross-reference UseCase lÃ  mandatory step trong Phase B |
| R8 | **M3 Discovery** khÃ´ng cÃ³ entity riÃªng â€” AI cÃ³ thá»ƒ bá» qua module | ğŸŸ¡ Tháº¥p | Module-map.yaml note rÃµ: M3 = cross-module, document pattern thay vÃ¬ collection |

---

### Cáº­p nháº­t 2.2 â€” Input Resolution Phase (bá»• sung vÃ o Process)

Phase ban Ä‘áº§u lÃ  6-phase. Sau khi cáº­p nháº­t Input Mechanism, thÃªm **Phase 0 â€” Input Resolution**:

```
Phase 0  â†’  Phase A  â†’  Phase B  â†’  Phase C  â†’  [IP1]  â†’  Phase D  â†’  [IP2]  â†’  Phase E  â†’  Phase F  â†’  [IP3+]
Resolve     Extract     CrossRef     Classify   Confirm    Gen .md    Review     Gen .yaml   Validate    Done
Input
(IP0 náº¿u
cáº§n)
```

---

## 9. Open Questions

| # | CÃ¢u há»i | Tráº¡ng thÃ¡i | Quyáº¿t Ä‘á»‹nh |
|---|---------|-----------|------------|
| Q1 | Entity `shares` thiáº¿u Entity Dictionary â€” dÃ¹ng provisional fields nÃ o? | âœ… Chá»‘t | Mark `[ASSUMPTION]`, thiáº¿t káº¿: `id, post_id, user_id, created_at` tÆ°Æ¡ng tá»± `likes` |
| Q2 | Skill build Ä‘áº§y Ä‘á»§ hay chá»‰ design.md trÆ°á»›c? | âœ… Chá»‘t | Design trÆ°á»›c â€” implementation sau |
| Q3 | Thá»© tá»± module? | âœ… Chá»‘t | Phase-based: M1 â†’ M2 â†’ M3 â†’ M4 â†’ M5 â†’ M6, tá»«ng module Ä‘á»™c láº­p |
| Q4 | M3 Discovery Feed khÃ´ng cÃ³ entity riÃªng â€” xá»­ lÃ½ tháº¿ nÃ o? | â“ Open | Option A: Bá» qua, document cross-module pattern. Option B: Táº¡o `FeedQuery` value object |
| Q5 | `post_media` vÃ  `post_tags` lÃ  join tables â€” Root hay Embedded? | â“ Open | Cáº§n quyáº¿t Ä‘á»‹nh khi lÃ m M2 â€” provisional: Embedded trong Post |
| Q6 | Skill 2.5 vÃ  Skill 2.6 cÃ³ share cÃ¹ng `knowledge/` khÃ´ng? | â“ Open | Kiáº¿n trÃºc hiá»‡n táº¡i: separate skills, separate knowledge â€” DRY qua `data/shared-types.json` |

---

## 10. Metadata

- **Skill Name**: `class-diagram-analyst`
- **Alias**: Skill 2.5 trong Task Pipeline
- **Created**: 2026-02-20
- **Author**: Skill Architect (VÅ© ThÆ°Æ¡ng Háº£i)
- **Framework**: architect.md v2.0
- **Status**: ğŸŸ¡ DESIGN COMPLETE â€” Ready for skill-planner â†’ skill-builder
- **Target Output Dir**: `Docs/life-2/diagrams/class-diagrams/`
- **YAML Contract Dir**: `Docs/life-2/diagrams/class-diagrams/mX-*/`
- **Next Skill**: `schema-design-analyst` (Skill 2.6) â€” Ä‘á»c YAML Contract tá»« skill nÃ y
- **Related Files**:
  - `Docs/life-2/diagrams/architect.databasse.md` â€” Nguá»“n gá»‘c spec nÃ y
  - `Docs/life-2/diagrams/er-diagram.md` â€” Primary input source
  - `.skill-context/class-diagram-analyst/todo.md` â€” Implementation plan (chá» skill-planner)

---

## Appendix A â€” Entity Inventory (Pre-classified)

Dá»±a trÃªn ER Diagram â€” inventory Ä‘áº§y Ä‘á»§ cho skill-planner vÃ  skill-builder:

| Entity | Module | Aggregate Root? | Source | Special Notes |
|--------|--------|----------------|--------|---------------|
| `users` | M1 | âœ… Root | er-diagram.md | Core entity â€” nhiá»u FK trá» vÃ o |
| `posts` | M2 | âœ… Root | er-diagram.md | CÃ³ ranking_score, denormalized counters |
| `media` | M2 | âœ… Root | er-diagram.md | PayloadCMS Upload collection riÃªng |
| `tags` | M2 | âœ… Root (nhá», ref) | er-diagram.md | Nhiá»u post â†’ nhiá»u tag (N:N) |
| `post_tags` | M2 | ğŸ“¦ Embedded | er-diagram.md | Join table â†’ nhÃºng vÃ o relationship |
| `post_media` | M2 | ğŸ“¦ Embedded | er-diagram.md | Join table â†’ nhÃºng vÃ o Post.media[] |
| _(feed logic)_ | M3 | âŒ No entity | er-diagram.md | Cross-module pattern â€” document strategy |
| `comments` | M4 | âœ… Root | er-diagram.md | CÃ³ parent_comment_id (threaded) |
| `likes` | M4 | âœ… Root | er-diagram.md | Unique (post_id, user_id) |
| `connections` | M4 | âœ… Root | er-diagram.md | Unique (follower_id, following_id) |
| `shares` | M4 | âœ… Root (provisional) | er-diagram.md tá»•ng quan | âš ï¸ [ASSUMPTION] thiáº¿u Entity Dict |
| `bookmark_collections` | M5 | âœ… Root | er-diagram.md | has_default flag |
| `bookmarks` | M5 | âœ… Root | er-diagram.md | Unique (user_id, post_id) |
| `notifications` | M6 | âœ… Root | er-diagram.md | Polymorphic (entity_type + entity_id) |
| `reports` | M6 | âœ… Root | er-diagram.md | Polymorphic (target_type + target_id) |
| `audit_logs` | M6 | âœ… Root | er-diagram.md | Append-only pattern |

**Tá»•ng**: 15 entities thá»±c, 1 provisional (`shares`), 1 cross-module pattern (M3 feed)

---

## Appendix B â€” File Output Spec

### Cáº¥u trÃºc thÆ° má»¥c output

```
Docs/life-2/diagrams/class-diagrams/
â”œâ”€â”€ index.md                              â† Routing + Status table
â”œâ”€â”€ m1-auth-profile/
â”‚   â”œâ”€â”€ class-m1-auth-profile.md          â† Human review (Mermaid)
â”‚   â””â”€â”€ class-m1-auth-profile.yaml       â† AI Contract (LOCKED)
â”œâ”€â”€ m2-content-engine/
â”‚   â”œâ”€â”€ class-m2-content-engine.md
â”‚   â””â”€â”€ class-m2-content-engine.yaml
â”œâ”€â”€ m3-discovery-feed/
â”‚   â”œâ”€â”€ class-m3-discovery-feed.md        â† Cross-module pattern doc
â”‚   â””â”€â”€ class-m3-discovery-feed.yaml
â”œâ”€â”€ m4-engagement/
â”‚   â”œâ”€â”€ class-m4-engagement.md
â”‚   â””â”€â”€ class-m4-engagement.yaml
â”œâ”€â”€ m5-bookmarking/
â”‚   â”œâ”€â”€ class-m5-bookmarking.md
â”‚   â””â”€â”€ class-m5-bookmarking.yaml
â””â”€â”€ m6-notifications-moderation/
    â”œâ”€â”€ class-m6-notifications.md
    â””â”€â”€ class-m6-notifications.yaml
```

### index.md Routing Table Format

```markdown
| Module | Markdown (Human) | YAML (AI Contract) | Status |
|--------|------------------|---------------------|--------|
| M1 Auth & Profile | m1-auth-profile/class-m1-auth-profile.md | m1-auth-profile/class-m1-auth-profile.yaml | â³ Pending |
| M2 Content Engine | m2-content-engine/class-m2-content-engine.md | m2-content-engine/class-m2-content-engine.yaml | â³ Pending |
| M3 Discovery Feed | m3-discovery-feed/class-m3-discovery-feed.md | m3-discovery-feed/class-m3-discovery-feed.yaml | â³ Pending |
| M4 Engagement     | m4-engagement/class-m4-engagement.md | m4-engagement/class-m4-engagement.yaml | â³ Pending |
| M5 Bookmarking    | m5-bookmarking/class-m5-bookmarking.md | m5-bookmarking/class-m5-bookmarking.yaml | â³ Pending |
| M6 Notifications  | m6-notifications-moderation/class-m6-notifications.md | m6-notifications-moderation/class-m6-notifications.yaml | â³ Pending |
```

### YAML Contract Format (Chuáº©n báº¯t buá»™c)

```yaml
# âš ï¸ LOCKED CONTRACT â€” DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: {date}

meta:
  module: "M1"
  module_name: "Auth & Profile"
  skill_version: "2.5"
  generated_at: "{date}"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"
    - "Docs/life-2/diagrams/UseCase/use-case-m1-auth-profile.md"
    - "Docs/life-2/diagrams/activity-diagrams/m1-a1-registration.md"

entities:
  - slug: "users"
    display_name: "User"
    payload_collection: "users"
    aggregate_root: true
    fields:
      - name: "email"
        type: "email"
        required: true
        unique: true
        indexed: true
        source: "er-diagram.md#L169"
    behaviors:
      - lifecycle: "beforeChange"
        trigger: "sanitize_input"
        source: "activity-diagrams/m1-a1-registration.md"
    access_control:
      create: ["anyone"]
      read: ["owner", "admin"]
      update: ["owner", "admin"]
      delete: ["admin"]
      source: "UseCase/use-case-m1-auth-profile.md#UC01"
    assumptions: []

validation_report:
  total_fields: 0
  fields_with_source: 0
  fields_as_assumption: 0
  unresolved: []
```
