# ui-pencil-drawer â€” Architecture Design

> Generated by Skill Architect | Date: 2026-02-21
> Status: ğŸŸ¢ COMPLETE
> Philosophy: **AGI-Oriented Autonomous Execution** â€” AI tá»± hiá»ƒu dá»± Ã¡n, tá»± quyáº¿t Ä‘á»‹nh, chá»‰ dá»«ng khi genuinely blocked. Human chá»‰ cung cáº¥p input ban Ä‘áº§u.

---

## 1. Problem Statement

**Váº¥n Ä‘á»**: Thiáº¿t káº¿ UI thá»§ cÃ´ng cho hÃ ng chá»¥c mÃ n hÃ¬nh (M1â€“M6) trong dá»± Ã¡n Steve Void ráº¥t tá»‘n thá»i gian â€” cáº§n kÃ©o tháº£, cÄƒn chá»‰nh tá»a Ä‘á»™, clone tá»«ng component má»™t trong Pencil canvas. Vá»›i 6 module má»—i module cÃ³ 3â€“8 mÃ n hÃ¬nh, quy trÃ¬nh manual táº¡o bottleneck nghiÃªm trá»ng trong Life-2.

**NgÆ°á»i dÃ¹ng**: Steve (developer + designer), Ä‘ang trong Life-2 design phase cá»§a KLTN, cáº§n chuyá»ƒn cÃ¡c file `Docs/life-2/ui/specs/*.md` thÃ nh UI hoÃ n chá»‰nh trong file `STi.pen`.

**LÃ½ do cáº§n skill**: Thay vÃ¬ váº½ tay tá»«ng pixel, skill sáº½: (1) tá»± boot context dá»± Ã¡n tá»« docs; (2) Ä‘á»c spec â†’ phÃ¢n tÃ­ch screens & component mapping; (3) táº¡o wireframe blueprint markdown; (4) tá»± Ä‘á»™ng clone components tá»« `Lib-Component` frame vÃ o canvas qua Pencil MCP tools. Triáº¿t lÃ½: **AI tá»± thá»±c thi end-to-end**, human chá»‰ cung cáº¥p spec path + `.pen` file path ban Ä‘áº§u. Má»¥c tiÃªu: tiáº¿t kiá»‡m 90%+ thá»i gian design thá»§ cÃ´ng, giáº£m thiá»ƒu human-in-the-loop.

---

## 2. Capability Map

### 2.1 Tri thá»©c (Knowledge â€” Pillar 1)

- **Project context**: Tá»± Ä‘á»c `check.list.md`, `Docs/life-2/specs/` Ä‘á»ƒ hiá»ƒu design direction, module scope, naming conventions
- **UI Spec format**: Hiá»ƒu cáº¥u trÃºc markdown specs vá»›i Screens, States, Block/Component mapping
- **Pencil MCP API**: 6 tools cáº§n dÃ¹ng â€” `batch_get`, `batch_design` (I/C/U/R/D ops), `find_empty_space_on_canvas`, `get_screenshot`, `snapshot_layout`, `get_editor_state`
- **Component library scanning**: Tá»± quÃ©t frame `Lib-Component` trong STi.pen Ä‘á»ƒ láº¥y reusable node IDs (khÃ´ng há»i user)
- **Wireframe blueprint format**: DOM Tree dáº¡ng text â€” phÃ¢n cáº¥p component, mapping sang Lib-Component IDs, override text

### 2.2 Quy trÃ¬nh (Process â€” Pillar 2)

> **Autonomous Execution Model**: AI tá»± cháº¡y end-to-end. Chá»‰ dá»«ng khi: (a) ambiguity khÃ´ng resolve Ä‘Æ°á»£c tá»« docs, hoáº·c (b) component thiáº¿u khÃ´ng cÃ³ fallback. KhÃ´ng há»i confirm cho tá»«ng phase.

**Phase 0 â€” Context Boot (má»›i):**

- HÃ nh Ä‘á»™ng: Tá»± Ä‘á»c `CLAUDE.md` â†’ `check.list.md` â†’ `Docs/life-2/ui/specs/` index â†’ `get_editor_state()` trÃªn STi.pen
- Output ná»™i bá»™: project_context object (module scope, design rules, canvas state)
- Rule: KhÃ´ng skip phase nÃ y. Context Boot Ä‘áº£m báº£o AI khÃ´ng hallucinate field names hay design patterns.

**Phase 1 â€” Spec Analyzer (autonomous):**

- Input: Spec file path (vÃ­ dá»¥: `Docs/life-2/ui/specs/m1-auth-ui-spec.md`)
- HÃ nh Ä‘á»™ng: Parse â†’ extract danh sÃ¡ch Screens, States, vÃ  Component Mapping
- Output ná»™i bá»™: screens[], component_map â€” AI tá»± tiáº¿n sang Phase 2 ngay
- Escalate only if: spec file khÃ´ng tá»“n táº¡i hoáº·c format khÃ´ng nháº­n dáº¡ng Ä‘Æ°á»£c

**Phase 2 â€” Wireframe Blueprint (autonomous):**

- Input: Káº¿t quáº£ Phase 1 (screens + component map)
- HÃ nh Ä‘á»™ng: Tá»± táº¡o wireframe blueprint (DOM Tree text) cho tá»«ng mÃ n hÃ¬nh
- Output: File `Docs/life-2/ui/wireframes/{module}-wireframe.md` â€” lÆ°u vÃ  tiáº¿n ngay
- Rule: Má»—i blueprint entry pháº£i cÃ³ source citation tá»« spec. Tá»± validate trÆ°á»›c khi tiáº¿n.

**Phase 3 â€” Pencil Drawer (autonomous self-correcting loop):**

- Input: Wireframe blueprint + file STi.pen Ä‘ang má»Ÿ
- HÃ nh Ä‘á»™ng: `batch_get` Lib-Component â†’ `find_empty_space_on_canvas` â†’ `batch_design` (I/C/U) â†’ `get_screenshot` â†’ self-verify â†’ next screen
- Rule: Váº½ 1 mÃ n hÃ¬nh / 1 `batch_design` call. Tá»± fix náº¿u screenshot khÃ´ng pass. Tá»‘i Ä‘a 2 retry/screen.
- Escalate only if: component missing + khÃ´ng cÃ³ fallback sau khi Ä‘Ã£ tÃ¬m Lib-Component

### 2.3 Kiá»ƒm soÃ¡t (Guardrails â€” Pillar 3)

- **G-Lib-Strict**: 100% resource pháº£i lÃ  `ref` type tá»« Lib-Component. KhÃ´ng tá»± váº½ rectangle/text thÃ´ náº¿u Lib-Component Ä‘Ã£ cÃ³ component tÆ°Æ¡ng Ä‘Æ°Æ¡ng.
- **G-Spec-Strict**: KhÃ´ng thÃªm field, button, hay element náº¿u spec file khÃ´ng Ä‘á» cáº­p. Má»—i component cáº§n cÃ³ source citation.
- **G-Canvas-Space**: Báº¯t buá»™c gá»i `find_empty_space_on_canvas` trÆ°á»›c má»—i batch_design session. KhÃ´ng váº½ Ä‘Ã¨ lÃªn Lib-Component frame.
- **G-One-Screen-Per-Call**: Má»—i batch_design call chá»‰ váº½ 1 mÃ n hÃ¬nh. Screenshot verify trÆ°á»›c khi váº½ mÃ n hÃ¬nh tiáº¿p theo.
- **G-Bounded-Creativity**: PhÃ¢n tÃ¡ch rÃµ *Strict Zones* (chá»‰ láº¯p ghÃ©p block 100% Ä‘Ãºng Spec) vÃ  *Fluid Zones* (Ä‘Æ°á»£c sÃ¡ng táº¡o spacing, copy, vÃ  dÃ¹ng hÃ m AI sinh hÃ¬nh áº£nh `G()`).

---

## 3. Zone Mapping

> âš ï¸ Contract Section â€” Planner Ä‘á»c Â§3 Ä‘á»ƒ decompose thÃ nh Tasks.
> Má»i Zone PHáº¢I cÃ³ giÃ¡ trá»‹ trong cá»™t "Files cáº§n táº¡o". Zone khÃ´ng dÃ¹ng â†’ ghi "KhÃ´ng cáº§n".

| Zone | Files cáº§n táº¡o | Ná»™i dung | Báº¯t buá»™c? |
| :--- | :--- | :--- | :--- |
| Core (SKILL.md) | `SKILL.md` | Persona: Autonomous UI Design Agent. 4 Phases (Phase 0â€“3). 5 Guardrails (ká»ƒ cáº£ Bounded-Creativity). Autonomous execution model: self-correcting, escalate only when genuinely blocked. | âœ… |
| Knowledge | `knowledge/pencil-tools-ref.md` | Reference Ä‘áº§y Ä‘á»§ syntax cho 6 Pencil MCP tools: batch_get, batch_design ops (I/C/U/R/D/G), find_empty_space_on_canvas, get_screenshot, snapshot_layout, get_editor_state | âœ… |
| Knowledge | `knowledge/wireframe-format.md` | Chuáº©n format wireframe blueprint: DOM Tree hierarchy, component mapping syntax, text override notation, source citation format | âœ… |
| Knowledge | `knowledge/project-context.md` | HÆ°á»›ng dáº«n AI Ä‘á»c project docs Ä‘á»ƒ self-orient: CLAUDE.md â†’ check.list.md â†’ ui/specs/ â†’ STi.pen. Naming conventions, module scope, design aesthetic (Neobrutalism + Pink). | âœ… |
| Knowledge | `knowledge/animation-tokens.md` | Bá»™ tá»« Ä‘iá»ƒn animation tokens â†’ Framer Motion specs â†’ Pencil `context` field assignment. 7 tokens (fade-up, scale-in, hover-lift, ...). DÃ¹ng trong Phase 3 Fluid Zones. Self-critique checklist cho animation. | âœ… |
| Scripts | `scripts/scan_lib_components.py` | QuÃ©t frame `Lib-Component` trong STi.pen qua batch_get, extract reusable node IDs, output JSON map tÃªnâ†’nodeId. DÃ¹ng trong Phase 0 Context Boot. | âœ… |
| Templates | `templates/wireframe.md.template` | Template markdown cho 1 mÃ n hÃ¬nh: header, layout-direction, component-slots, source-citation, states, notes | âœ… |
| Data | `data/layout-rules.yaml` | Static rules: default gap (24px), padding (16/24/32px), screen width (375/1440px), frame naming convention, retry limits | âœ… |
| Loop | `loop/checklist.md` | Autonomous self-verify checklist â€” AI cháº¡y sau má»—i Phase: spec coverage, no hallucinated components, no canvas overlaps, screenshot quality. Äá»‹nh nghÄ©a pass/fail threshold Ä‘á»ƒ tá»± quyáº¿t tiáº¿n hay fix. | âœ… |
| Assets | KhÃ´ng cáº§n | N/A | âŒ |

---

## 4. Folder Structure

```mermaid
mindmap
  root((ui-pencil-drawer))
    SKILL.md
      Persona: Autonomous UI Agent
      Phase 0 Context Boot
      Phase 1 Spec Analyzer
      Phase 2 Wireframe Blueprint
      Phase 3 Pencil Drawer
      G-Lib-Strict
      G-Spec-Strict
      G-Canvas-Space
      G-One-Screen-Per-Call
      G-Bounded-Creativity
      G-Autonomous-Proceed
    knowledge
      pencil-tools-ref.md
      wireframe-format.md
      project-context.md
      animation-tokens.md
    scripts
      scan_lib_components.py
    templates
      wireframe.md.template
    data
      layout-rules.yaml
    loop
      checklist.md
```

---

## 5. Execution Flow

```mermaid
sequenceDiagram
    participant U as User
    participant A as AI Agent
    participant K as Knowledge
    participant Pen as Pencil MCP
    participant FS as File System
    participant L as Loop

    U->>A: Trigger + spec_path + pen_file_path

    Note over A: Phase 0 â€” Context Boot (autonomous)
    A->>K: Read SKILL.md, pencil-tools-ref.md, project-context.md
    A->>FS: Read CLAUDE.md, check.list.md, Docs/life-2/ui/specs/ index
    A->>Pen: get_editor_state() â†’ verify STi.pen open
    A->>A: Build project_context (module scope, design rules, canvas state)

    Note over A: Phase 1 â€” Spec Analyzer (autonomous)
    A->>FS: Read spec file
    A->>A: Parse â†’ extract Screens[], States, Component Map
    A->>L: Self-verify: all screens extracted? citations present?
    Note over A: [Auto-proceed â€” no human gate]

    Note over A: Phase 2 â€” Wireframe Blueprint (autonomous)
    A->>K: Read templates/wireframe.md.template, layout-rules.yaml
    A->>A: Generate wireframe blueprint per screen (DOM Tree + citations)
    A->>FS: Save to Docs/life-2/ui/wireframes/{module}-wireframe.md
    A->>L: Self-verify: no hallucinated components? spec coverage 100%?
    Note over A: [Auto-proceed â€” no human gate]

    Note over A: Phase 3 â€” Pencil Drawer (autonomous self-correcting loop)
    loop For each screen in screens[]
        A->>Pen: batch_get Lib-Component â†’ collect real node IDs
        A->>Pen: find_empty_space_on_canvas â†’ get safe position
        A->>Pen: batch_design I/C/U â†’ draw screen
        A->>Pen: get_screenshot â†’ visual verify
        A->>L: Self-verify checklist (overlap? wrong component? spec match?)
        alt Pass (all checks green)
            A->>A: Proceed to next screen autonomously
        else Fail â€” fixable (overlap / wrong node)
            A->>Pen: Fix â†’ redraw (max 2 retries)
        else Fail â€” blocked (component missing, no fallback)
            A->>U: âš ï¸ ESCALATE â€” report blocker + proposed resolution
            U->>A: Decision
        end
    end
    A->>U: âœ… Done â€” summary report (N screens drawn, M warnings)
```

---

## 5b. Workflow Phases

```mermaid
flowchart LR
    START([User: spec_path + pen_file_path]) --> P0

    subgraph P0 [Phase 0: Context Boot]
        B1[Read CLAUDE.md + check.list.md] --> B2[Scan ui/specs/ index]
        B2 --> B3[get_editor_state on STi.pen]
        B3 --> B4[Build project_context object]
    end

    subgraph P1 [Phase 1: Spec Analyzer â€” Autonomous]
        S1A[Read spec file] --> S1B[Extract Screens + States + Component Map]
        S1B --> S1C{Self-verify:\nall extracted?}
        S1C -->|Pass| S1D[Auto-proceed âœ…]
        S1C -->|Fail| S1E[âš ï¸ Escalate: spec unreadable]
    end

    subgraph P2 [Phase 2: Wireframe Blueprint â€” Autonomous]
        S2A[Load template + layout-rules] --> S2B[Generate DOM Tree per screen]
        S2B --> S2C[Save to wireframes/]
        S2C --> S2D{Self-verify:\nno hallucinations?}
        S2D -->|Pass| S2E[Auto-proceed âœ…]
        S2D -->|Fail| S2F[Self-correct â†’ re-generate]
    end

    subgraph P3 [Phase 3: Pencil Drawer â€” Autonomous Loop]
        S3A[batch_get Lib-Component] --> S3B[find_empty_space_on_canvas]
        S3B --> S3C[batch_design â€” draw 1 screen]
        S3C --> S3D[get_screenshot verify]
        S3D --> S3E{Self-verify:\nchecklist pass?}
        S3E -->|Pass| S3F{More screens?}
        S3F -->|Yes| S3B
        S3F -->|No| DONE
        S3E -->|Fail fixable| S3G[Self-fix â†’ retry â‰¤2x]
        S3G --> S3C
        S3E -->|Fail blocked| S3H[âš ï¸ Escalate to User]
        S3H --> S3B
    end

    P0 --> P1 --> P2 --> P3
    DONE([âœ… Summary report to User])
```

---

## 6. Interaction Points

> **AGI Principle**: AI khÃ´ng há»i confirm cho tá»«ng phase. Chá»‰ escalate khi gáº·p hard blocker mÃ  khÃ´ng thá»ƒ tá»± resolve. Default behavior = tá»± quyáº¿t Ä‘á»‹nh vÃ  tiáº¿n.

| # | Trigger | Äiá»u kiá»‡n escalate | HÃ nh Ä‘á»™ng cá»§a AI |
| :--- | :--- | :--- | :--- |
| 1 | Phase 0 â€” STi.pen khÃ´ng má»Ÿ hoáº·c khÃ´ng tÃ¬m tháº¥y | `get_editor_state` tráº£ vá» null vÃ  khÃ´ng cÃ³ pen file path há»£p lá»‡ tá»« user | BÃ¡o lá»—i + hÆ°á»›ng dáº«n: "Vui lÃ²ng má»Ÿ STi.pen trÆ°á»›c" |
| 2 | Phase 3 â€” Component missing sau khi Ä‘Ã£ tÃ¬m toÃ n bá»™ Lib-Component | Component trong wireframe blueprint khÃ´ng match báº¥t ká»³ node nÃ o trong Lib-Component (sau fuzzy search) | BÃ¡o: `[BLOCKED] Component "{name}" khÃ´ng tá»“n táº¡i trong Lib-Component. Options: (a) skip, (b) dÃ¹ng primitive, (c) báº¡n thÃªm vÃ o Lib-Component rá»“i AI continue` |

**KhÃ´ng escalate (AI tá»± xá»­ lÃ½):**

- Overlap nhá» â†’ tá»± gá»i láº¡i `find_empty_space_on_canvas` vá»›i padding lá»›n hÆ¡n
- Screenshot quality tháº¥p â†’ tá»± retry `batch_design` (max 2 láº§n)
- Spec section khÃ´ng rÃµ â†’ tá»± inference tá»« project_context + ghi note trong wireframe
- Component tÃªn gáº§n giá»‘ng â†’ tá»± dÃ¹ng best-match tá»« Lib-Component scan

---

## 7. Progressive Disclosure Plan

### Tier 0: Phase 0 Boot (trÆ°á»›c khi lÃ m báº¥t cá»© gÃ¬)

- `SKILL.md` â€” load persona + autonomous execution model
- `knowledge/project-context.md` â€” hÆ°á»›ng dáº«n Ä‘á»c project docs Ä‘á»ƒ self-orient
- Sau Ä‘Ã³: tá»± Ä‘á»c `CLAUDE.md` + `check.list.md` + `Docs/life-2/ui/specs/` index

### Tier 1: Báº¯t buá»™c Ä‘á»c trÆ°á»›c Phase 2 (Mandatory)

- `knowledge/pencil-tools-ref.md` â€” Pencil MCP API syntax (cáº§n trÆ°á»›c Phase 3)
- `knowledge/wireframe-format.md` â€” blueprint format + source citation chuáº©n

### Tier 2: Äá»c khi cáº§n (Conditional â€” AI tá»± quyáº¿t khi nÃ o Ä‘á»c)

- `templates/wireframe.md.template` â€” khi báº¯t Ä‘áº§u generate wireframe (Phase 2)
- `data/layout-rules.yaml` â€” khi cáº§n spacing/padding/screen-width reference
- `loop/checklist.md` â€” sau má»—i Phase Ä‘á»ƒ self-verify pass/fail threshold

---

## 8. Risks & Blind Spots

| # | Risk | Severity | Mitigation |
| :--- | :--- | :--- | :--- |
| 1 | AI bá»‹a component IDs khÃ´ng tá»“n táº¡i trong Lib-Component | P0 | G-Lib-Strict: Phase 0 báº¯t buá»™c gá»i `batch_get` Ä‘á»ƒ scan toÃ n bá»™ Lib-Component trÆ°á»›c. Cache káº¿t quáº£. Tuyá»‡t Ä‘á»‘i khÃ´ng hardcode IDs. |
| 2 | Váº½ Ä‘Ã¨ lÃªn Lib-Component frame hoáº·c cÃ¡c screen Ä‘Ã£ váº½ | P0 | G-Canvas-Space: báº¯t buá»™c gá»i `find_empty_space_on_canvas` trÆ°á»›c má»—i `batch_design`. Verify `snapshot_layout` sau khi váº½. |
| 3 | ThÃªm UI elements khÃ´ng cÃ³ trong spec (hallucination) | P1 | G-Spec-Strict: má»—i component trong wireframe blueprint pháº£i cÃ³ source citation. AI tá»± validate trÆ°á»›c khi tiáº¿n â€” khÃ´ng cáº§n human review. |
| 4 | batch_design call quÃ¡ nhiá»u ops, AI bá»‹ rá»‘i/nháº§m node IDs | P1 | G-One-Screen-Per-Call: max 1 mÃ n hÃ¬nh / 1 batch_design call. Screenshot + self-verify sau má»—i call. Tá»± retry náº¿u fail. |
| 5 | Autonomous mode bá» qua lá»—i, tÃ­ch lÅ©y sai sÃ³t qua nhiá»u mÃ n hÃ¬nh | P1 | G-Fail-Fast: má»—i Phase cÃ³ pass/fail threshold rÃµ rÃ ng trong checklist.md. Náº¿u self-verify fail 2 láº§n liÃªn tiáº¿p â†’ escalate thay vÃ¬ tiáº¿p tá»¥c. |
| 6 | Wireframe blueprint quÃ¡ phá»©c táº¡p lÃ m AI lost orientation trong Phase 3 | P2 | Giá»›i háº¡n má»—i wireframe blueprint file 1 mÃ n hÃ¬nh. Build context object trong Phase 0 Ä‘á»ƒ AI luÃ´n biáº¿t mÃ¬nh Ä‘ang á»Ÿ Ä‘Ã¢u trong execution. |

---

## 9. Open Questions

| # | CÃ¢u há»i | Nguá»“n | Tráº¡ng thÃ¡i |
| :--- | :--- | :--- | :--- |
| 1 | File `.pen` cá»¥ thá»ƒ á»Ÿ Ä‘Æ°á»ng dáº«n nÃ o trong project? (prompt.md nÃ³i `STi.pen`) | Phase 0 | âœ… Resolved: AI nháº­n pen_file_path tá»« trigger input. Náº¿u khÃ´ng cÃ³ â†’ `get_editor_state()` láº¥y file Ä‘ang má»Ÿ. |
| 2 | `Lib-Component` lÃ  tÃªn frame trong STi.pen hay file pen riÃªng? | Phase 0 | âœ… Resolved: Phase 0 tá»± gá»i `batch_get` vá»›i pattern `{name: "Lib-Component"}` Ä‘á»ƒ tÃ¬m. KhÃ´ng cáº§n há»i user. |
| 3 | Má»—i mÃ n hÃ¬nh cáº§n váº½ full states (error, loading, empty) hay chá»‰ default state? | Phase 1 | âœ… Resolved: Default = chá»‰ váº½ default state. Full states lÃ  optional â€” AI inference tá»« spec (náº¿u spec Ä‘á» cáº­p states thÃ¬ váº½, khÃ´ng thÃ¬ bá» qua). |
| 4 | `scan_lib_components.py` cáº§n tÃ­ch há»£p vá»›i Pencil MCP nhÆ° tháº¿ nÃ o? Script Python khÃ´ng gá»i Ä‘Æ°á»£c MCP trá»±c tiáº¿p | Ká»¹ thuáº­t | âœ… Resolved: Script khÃ´ng gá»i MCP. Thay vÃ o Ä‘Ã³: AI thá»±c hiá»‡n `batch_get` trá»±c tiáº¿p trong Phase 0, lÆ°u káº¿t quáº£ vÃ o internal component_map. Script chá»‰ lÃ  reference / post-process helper náº¿u cáº§n. |

---

## 10. Metadata

- **Skill Name**: `ui-pencil-drawer`
- **Created**: 2026-02-21
- **Updated**: 2026-02-21 â€” AGI-oriented autonomous execution model
- **Author**: Skill Architect (AI) â€” based on prompt.md by Steve
- **Framework**: architect.md v2.0
- **Execution Model**: Autonomous â€” AI tá»± thá»±c thi end-to-end, human chá»‰ cung cáº¥p spec_path + pen_file_path. Escalate only when genuinely blocked.
- **Status**: ğŸŸ¢ COMPLETE (v2 â€” AGI philosophy)
- **Handoff Checklist**:
  - [x] design.md hoÃ n thiá»‡n (checklist pass)
  - [x] Phase 0 Context Boot Ä‘Æ°á»£c thiáº¿t káº¿
  - [x] Interaction Points giáº£m tá»« 4 â†’ 2 (hard blockers only)
  - [x] Â§9 Open Questions: táº¥t cáº£ 4 cÃ¢u Ä‘Ã£ resolved
  - [x] Sáºµn sÃ ng cho skill-planner
