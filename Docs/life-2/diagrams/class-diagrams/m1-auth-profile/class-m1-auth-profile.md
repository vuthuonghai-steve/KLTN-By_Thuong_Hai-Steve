# class-m1 — Auth & Profile Class Diagram

> **Module**: M1 — Auth & Profile
> **Generated by**: Skill 2.5 (class-diagram-analyst)
> **Date**: 2026-02-20
> **Status**: ✅ Approved (IP2)
> **Source**: `Docs/life-2/diagrams/er-diagram.md` + `activity-diagrams/m1-a*.md` + `UseCase/use-case-m1-auth-profile.md`

---

## Class Diagram (Mermaid)

```mermaid
classDiagram
    namespace AuthProfile {

        class User {
            <<Collection>>
            +ObjectId id
            +String email
            +String username
            -String passwordHash
            +Boolean verified
            +String role
            +String status
            +String profileVisibility
            +String displayName
            +String bio
            +String avatar
            +Array bookmarkCollections
            +Array notifications
            +Number unreadNotificationsCount
            +Number followerCount
            +Number followingCount
            +DateTime createdAt
            +DateTime updatedAt
            +void beforeChange_sanitizeInput()
            +void afterChange_sendVerification()
        }

    }
```

> **Chú ý**:
> - `passwordHash` dùng visibility `-` (private) — không được expose qua API
> - `role`: enum `member | admin`
> - `status`: enum `active | inactive | banned`
> - `profileVisibility`: enum `public | followers | private`
> - `followerCount`, `followingCount`: Computed Pattern (denormalized, readOnly)

---

## Traceability Table

| Entity | Field | Source | Assumption? |
|--------|-------|--------|------------|
| `user` | `id` | `er-diagram.md#USERS.id` | ❌ |
| `user` | `email` | `er-diagram.md#USERS.email` | ❌ |
| `user` | `username` | `er-diagram.md#USERS.username` | ❌ |
| `user` | `passwordHash` | `er-diagram.md#USERS.password_hash` | ❌ |
| `user` | `verified` | `er-diagram.md#USERS.verified` | ❌ |
| `user` | `role` | `er-diagram.md#USERS.role` | ❌ |
| `user` | `status` | `er-diagram.md#USERS.status` | ❌ |
| `user` | `profileVisibility` | `er-diagram.md#USERS.profile_visibility` | ❌ |
| `user` | `followerCount` | `er-diagram.md#USERS.follower_count` | ❌ |
| `user` | `followingCount` | `er-diagram.md#USERS.following_count` | ❌ |
| `user` | `createdAt` | `er-diagram.md#USERS.created_at` | ❌ |
| `user` | `updatedAt` | `er-diagram.md#USERS.updated_at` | ❌ |
| `user` | `displayName` | `activity-diagrams/m1-a5-onboarding.md` | `[FROM_CONTEXT]` |
| `user` | `bio` | `activity-diagrams/m1-a5-onboarding.md` | `[FROM_CONTEXT]` |
| `user` | `avatar` | `activity-diagrams/m1-a5-onboarding.md` | `[FROM_CONTEXT]` |
| `user` | `bookmarkCollections` | `ui-specs/m5-bookmarking-ui-spec.md` | `[FROM_CONTEXT]` |
| `user` | `notifications` | `ui-specs/m6-notifications-ui-spec.md` | `[FROM_CONTEXT]` |
| `user` | `unreadNotificationsCount` | `ui-specs/m6-notifications-ui-spec.md` | `[FROM_CONTEXT]` |
| `user` | `beforeChange_sanitizeInput()` | `activity-diagrams/m1-a1-registration.md` (C2: Sanitize Input) | ❌ |
| `user` | `afterChange_sendVerification()` | `activity-diagrams/m1-a1-registration.md` (C5: Tạo Activation Token) | ❌ |

---

## Assumption Register

> Không có assumption. Mọi field đều có nguồn trong ER Dictionary.

---

## Entity Overview

| Entity | Stereotype | Aggregate Root | Behaviors (summary) | Access (summary) |
|--------|-----------|---------------|---------------------|-----------------|
| `user` | `<<Collection>>` | ✅ | beforeChange: sanitize input; afterChange: send verification email | create: guest (UC01); read: member/public (UC07); update: owner (UC06); delete: admin |

---

## Notes

- **Computed Counters**: `followerCount` và `followingCount` được cập nhật bởi `afterChange` hook trong `connections` collection (Pattern: Computed/Denormalized).
- **Auth Flow**: `verified: false` khi đăng ký (UC01), chuyển `true` sau xác thực email (M1-A3).
- **RBAC**: `role: member | admin` kiểm soát toàn bộ access control trong hệ thống.
- **Soft-delete**: Sử dụng `status: banned` thay vì hard-delete.

---

*Approved tại IP2 — Ready for YAML Contract generation.*
