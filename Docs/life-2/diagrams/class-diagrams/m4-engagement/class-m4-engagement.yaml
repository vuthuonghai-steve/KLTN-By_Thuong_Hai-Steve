# ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: 2026-02-20
# UPDATED: All 3 ASSUMPTION fields in 'shares' entity have been resolved.
# Source added: er-diagram.md#SHARES (new Entity Dictionary) + flow/flow-post-share.md
# Previous assumptions: postId, userId, createdAt — NOW RESOLVED.

meta:
  module: "M4"
  module_name: "Engagement & Connections"
  skill_version: "2.5"
  generated_at: "2026-02-20"
  updated_at: "2026-02-20"
  update_reason: "Resolved 3 ASSUMPTION fields in shares entity after research of flow-post-share.md + er-diagram.md SHARES Entity Dictionary added"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"
    - "Docs/life-2/diagrams/UseCase/use-case-m4-engagement-connections.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a1-friendship-handshake.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a2-engagement-logic.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a3-connection-privacy.md"
    - "Docs/life-2/diagrams/flow/flow-post-share.md"
    - "Docs/life-1/01-vision/FR/requirements-srs.md"
    - "Docs/life-1/01-vision/user-stories.md"

entities:
  - slug: "comments"
    display_name: "Comment"
    payload_collection: "comments"
    aggregate_root: true
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.post_id"

      - name: "authorId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.author_id"

      - name: "parentCommentId"
        type: "relationship"
        relationTo: "comments"
        required: false
        indexed: true
        note: "null = top-level comment; non-null = threaded reply"
        source: "er-diagram.md#COMMENTS.parent_comment_id"

      - name: "content"
        type: "text"
        required: true
        source: "er-diagram.md#COMMENTS.content"

      - name: "status"
        type: "select"
        required: true
        options: ["visible", "hidden", "deleted"]
        defaultValue: "visible"
        indexed: true
        source: "er-diagram.md#COMMENTS.status"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.created_at"

      - name: "updatedAt"
        type: "date"
        required: true
        source: "er-diagram.md#COMMENTS.updated_at"

    behaviors:
      - lifecycle: "beforeChange"
        trigger: "sanitizeContent"
        description: "Kiểm tra từ cấm, sanitize nội dung comment"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C5: Kiểm tra từ cấm trong Comment)"

      - lifecycle: "afterChange"
        trigger: "updateCommentCount"
        description: "Cập nhật posts.commentsCount (Computed Pattern)"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C4 → D2 → D1 Posts)"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có comment mới"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C6: Gửi thông báo Local - Triggers M6)"

    access_control:
      create: ["member"]
      read: ["member", "public"]
      update: ["owner"]
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC15"

    assumptions: []

  - slug: "likes"
    display_name: "Like"
    payload_collection: "likes"
    aggregate_root: true
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        source: "er-diagram.md#LIKES.post_id"

      - name: "userId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#LIKES.user_id"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md#LIKES.created_at"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateLikeCount"
        description: "Cập nhật posts.likesCount — Tăng khi create, Giảm khi delete (toggle)"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C3: Xử lý Like: Tăng/Giảm Like Count)"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có like mới"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C6: Gửi thông báo Local)"

    access_control:
      create: ["member"]
      read: ["member"]
      update: []
      delete: ["owner"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC14"

    compound_indexes:
      - fields: ["postId", "userId"]
        unique: true
        note: "Unique constraint — một user chỉ like 1 lần per post"

    assumptions: []

  - slug: "connections"
    display_name: "Connection"
    payload_collection: "connections"
    aggregate_root: true
    fields:
      - name: "followerId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#CONNECTIONS.follower_id"

      - name: "followingId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#CONNECTIONS.following_id"

      - name: "status"
        type: "select"
        required: true
        options: ["active"]
        defaultValue: "active"
        note: "future-proof — currently only 'active'"
        source: "er-diagram.md#CONNECTIONS.status"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md#CONNECTIONS.created_at"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateFollowerCount"
        description: "Cập nhật users.followerCount của followingId"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

      - lifecycle: "afterChange"
        trigger: "updateFollowingCount"
        description: "Cập nhật users.followingCount của followerId"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có follow mới"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

    access_control:
      create: ["member"]
      read: ["member"]
      update: []
      delete: ["owner"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC17"

    compound_indexes:
      - fields: ["followerId", "followingId"]
        unique: true
        note: "Unique constraint — không follow 2 lần cùng 1 user"

    assumptions: []

  - slug: "shares"
    display_name: "Share"
    payload_collection: "shares"
    aggregate_root: true
    architecture_note: |
      Share UC16 có 2 nhánh:
      1. copy_link: Chỉ ghi audit record + tăng posts.shares_count. Không tạo Post mới.
      2. repost: Tạo Post mới (posts collection) với sharedFromId = post_id gốc. Ghi audit record.
      Collection 'shares' = Audit Trail. Source: flow/flow-post-share.md (UC16).
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        note: "Bài viết gốc được share"
        source: "er-diagram.md#SHARES.post_id"

      - name: "userId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        note: "Người thực hiện hành động share"
        source: "er-diagram.md#SHARES.user_id"

      - name: "shareType"
        type: "select"
        required: true
        options: ["copy_link", "repost"]
        indexed: true
        note: "copy_link = chỉ copy URL + tăng counter; repost = tạo Post mới + tăng counter"
        source: "er-diagram.md#SHARES.share_type + flow/flow-post-share.md (2 nhánh UC16)"

      - name: "sharedPostId"
        type: "relationship"
        relationTo: "posts"
        required: false
        indexed: false
        note: "nullable — chỉ có giá trị khi shareType=repost (ID của Post mới được tạo)"
        source: "er-diagram.md#SHARES.shared_post_id + flow/flow-post-share.md (D2: Insert Post mới)"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        note: "Audit timestamp"
        source: "er-diagram.md#SHARES.created_at"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateShareCount"
        description: "Cập nhật posts.sharesCount (Computed Pattern) — áp dụng cho cả copy_link và repost"
        source: "er-diagram.md#POSTS.shares_count (denormalized counter) + flow/flow-post-share.md (D1: Update Posts.shares +1)"

    access_control:
      create: ["member"]
      read: ["public"]
      update: []
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC16"

    assumptions: []

validation_report:
  total_fields: 18
  fields_with_source: 18
  fields_as_assumption: 0
  unresolved: []
  resolved_assumptions:
    - entity: "shares"
      previously_assumed: ["postId", "userId", "createdAt"]
      resolved_at: "2026-02-20"
      resolved_by: "Research: er-diagram.md (SHARES entity dict added) + flow/flow-post-share.md"
      additional_fields_found: ["shareType", "sharedPostId"]
