# ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: 2026-02-20
# To update: re-run generate_yaml.py after editing class-m4-engagement.md and re-approval at IP2.
# NOTE: 'shares' entity has 4 [ASSUMPTION] fields — confirm with team before implementing.

meta:
  module: "M4"
  module_name: "Engagement & Connections"
  skill_version: "2.5"
  generated_at: "2026-02-20"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"
    - "Docs/life-2/diagrams/UseCase/use-case-m4-engagement-connections.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a1-friendship-handshake.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a2-engagement-logic.md"
    - "Docs/life-2/diagrams/activity-diagrams/m4-a3-connection-privacy.md"

entities:
  - slug: "comments"
    display_name: "Comment"
    payload_collection: "comments"
    aggregate_root: true
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.post_id"

      - name: "authorId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.author_id"

      - name: "parentCommentId"
        type: "relationship"
        relationTo: "comments"
        required: false
        indexed: true
        note: "null = top-level comment; non-null = threaded reply"
        source: "er-diagram.md#COMMENTS.parent_comment_id"

      - name: "content"
        type: "text"
        required: true
        source: "er-diagram.md#COMMENTS.content"

      - name: "status"
        type: "select"
        required: true
        options: ["visible", "hidden", "deleted"]
        defaultValue: "visible"
        indexed: true
        source: "er-diagram.md#COMMENTS.status"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#COMMENTS.created_at"

      - name: "updatedAt"
        type: "date"
        required: true
        source: "er-diagram.md#COMMENTS.updated_at"

    behaviors:
      - lifecycle: "beforeChange"
        trigger: "sanitizeContent"
        description: "Kiểm tra từ cấm, sanitize nội dung comment"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C5: Kiểm tra từ cấm trong Comment)"

      - lifecycle: "afterChange"
        trigger: "updateCommentCount"
        description: "Cập nhật posts.commentsCount (Computed Pattern)"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C4 → D2 → D1 Posts)"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có comment mới"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C6: Gửi thông báo Local - Triggers M6)"

    access_control:
      create: ["member"]
      read: ["member", "public"]
      update: ["owner"]
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC15"

    assumptions: []

  - slug: "likes"
    display_name: "Like"
    payload_collection: "likes"
    aggregate_root: true
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        source: "er-diagram.md#LIKES.post_id"

      - name: "userId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#LIKES.user_id"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md#LIKES.created_at"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateLikeCount"
        description: "Cập nhật posts.likesCount — Tăng khi create, Giảm khi delete (toggle)"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C3: Xử lý Like: Tăng/Giảm Like Count)"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có like mới"
        source: "activity-diagrams/m4-a2-engagement-logic.md (C6: Gửi thông báo Local)"

    access_control:
      create: ["member"]
      read: ["member"]
      update: []
      delete: ["owner"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC14"

    compound_indexes:
      - fields: ["postId", "userId"]
        unique: true
        note: "Unique constraint — một user chỉ like 1 lần per post"

    assumptions: []

  - slug: "connections"
    display_name: "Connection"
    payload_collection: "connections"
    aggregate_root: true
    fields:
      - name: "followerId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#CONNECTIONS.follower_id"

      - name: "followingId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#CONNECTIONS.following_id"

      - name: "status"
        type: "select"
        required: true
        options: ["active"]
        defaultValue: "active"
        note: "future-proof — currently only 'active'"
        source: "er-diagram.md#CONNECTIONS.status"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md#CONNECTIONS.created_at"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateFollowerCount"
        description: "Cập nhật users.followerCount của followingId"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

      - lifecycle: "afterChange"
        trigger: "updateFollowingCount"
        description: "Cập nhật users.followingCount của followerId"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

      - lifecycle: "afterChange"
        trigger: "triggerNotification"
        description: "Gọi M6 notification service khi có follow mới"
        source: "activity-diagrams/m4-a1-friendship-handshake.md"

    access_control:
      create: ["member"]
      read: ["member"]
      update: []
      delete: ["owner"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC17"

    compound_indexes:
      - fields: ["followerId", "followingId"]
        unique: true
        note: "Unique constraint — không follow 2 lần cùng 1 user"

    assumptions: []

  - slug: "shares"
    display_name: "Share"
    payload_collection: "shares"
    aggregate_root: true
    fields:
      - name: "postId"
        type: "relationship"
        relationTo: "posts"
        required: true
        indexed: true
        assumption: true
        source: "[ASSUMPTION] — suy luận từ quan hệ POSTS→SHARES trong ERD tổng quan"

      - name: "userId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        assumption: true
        source: "[ASSUMPTION] — suy luận từ quan hệ USERS→SHARES trong ERD tổng quan"

      - name: "createdAt"
        type: "date"
        required: true
        assumption: true
        source: "[ASSUMPTION] — theo pattern tương tự likes collection"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "updateShareCount"
        description: "Cập nhật posts.sharesCount (Computed Pattern)"
        source: "er-diagram.md#POSTS.shares_count (denormalized counter)"

    access_control:
      create: ["member"]
      read: ["public"]
      update: []
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m4-engagement-connections.md#UC16"

    assumptions:
      - "postId"
      - "userId"
      - "createdAt"

validation_report:
  total_fields: 18
  fields_with_source: 18
  fields_as_assumption: 3
  unresolved: []
  assumption_warnings:
    - entity: "shares"
      fields: ["postId", "userId", "createdAt"]
      note: "SHARES entity thiếu Entity Dictionary trong er-diagram.md. Fields provisional — cần xác nhận với team."
