# ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: 2026-02-20
# To update: re-run generate_yaml.py after editing class-m2-content-engine.md and re-approval at IP2.

meta:
  module: "M2"
  module_name: "Content Engine"
  skill_version: "2.5"
  generated_at: "2026-02-20"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"
    - "Docs/life-2/diagrams/UseCase/use-case-m2-content-engine.md"
    - "Docs/life-2/diagrams/activity-diagrams/m2-a1-editor-pipeline.md"
    - "Docs/life-2/diagrams/activity-diagrams/m2-a2-media-handler.md"
    - "Docs/life-2/diagrams/activity-diagrams/m2-a3-post-integrity.md"
    - "Docs/life-2/diagrams/activity-diagrams/m2-a4-visibility.md"

entities:
  - slug: "posts"
    display_name: "Post"
    payload_collection: "posts"
    aggregate_root: true
    fields:
      - name: "authorId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#POSTS.author_id"

      - name: "title"
        type: "text"
        required: false
        indexed: true
        note: "text index for search"
        source: "er-diagram.md#POSTS.title"

      - name: "content"
        type: "richText"
        required: true
        indexed: true
        note: "text index for search; Lexical rich-text JSON"
        source: "er-diagram.md#POSTS.content"

      - name: "status"
        type: "select"
        required: true
        options: ["draft", "published", "banned", "archived"]
        defaultValue: "draft"
        indexed: true
        source: "er-diagram.md#POSTS.status"

      - name: "visibility"
        type: "select"
        required: true
        options: ["public", "friends", "private"]
        defaultValue: "public"
        indexed: true
        source: "er-diagram.md#POSTS.visibility"

      - name: "rankingScore"
        type: "number"
        required: false
        indexed: true
        admin:
          readOnly: true
        pattern: "Computed Pattern — updated by async ranking service"
        source: "er-diagram.md#POSTS.ranking_score"

      - name: "likesCount"
        type: "number"
        required: true
        defaultValue: 0
        admin:
          readOnly: true
        pattern: "Computed Pattern — updated by Likes afterChange hook"
        source: "er-diagram.md#POSTS.likes_count"

      - name: "commentsCount"
        type: "number"
        required: true
        defaultValue: 0
        admin:
          readOnly: true
        pattern: "Computed Pattern — updated by Comments afterChange hook"
        source: "er-diagram.md#POSTS.comments_count"

      - name: "sharesCount"
        type: "number"
        required: true
        defaultValue: 0
        admin:
          readOnly: true
        pattern: "Computed Pattern — updated by Shares afterChange hook"
        source: "er-diagram.md#POSTS.shares_count"

      - name: "publishedAt"
        type: "date"
        required: false
        indexed: true
        source: "er-diagram.md#POSTS.published_at"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#POSTS.created_at"

      - name: "updatedAt"
        type: "date"
        required: true
        source: "er-diagram.md#POSTS.updated_at"

      - name: "tags"
        type: "relationship"
        relationTo: "tags"
        hasMany: true
        required: false
        note: "Replaces post_tags join table — embedded as ObjectId[]"
        source: "er-diagram.md (POST_TAGS join table → embedded strategy)"

      - name: "mediaItems"
        type: "relationship"
        relationTo: "media"
        hasMany: true
        required: false
        note: "Replaces post_media join table — embedded as ObjectId[]"
        source: "er-diagram.md (POST_MEDIA join table → embedded strategy)"

    behaviors:
      - lifecycle: "beforeChange"
        trigger: "sanitizeXSS"
        description: "Sanitize HTML/JSON content để chống XSS (dompurify/Lexical validator)"
        source: "activity-diagrams/m2-a1-editor-pipeline.md (C2: Xử lý Sanitize HTML/JSON)"

      - lifecycle: "beforeChange"
        trigger: "extractHashtags"
        description: "Phân tách hashtag từ content, upsert Tag documents, gán IDs vào tags[]"
        source: "activity-diagrams/m2-a3-post-integrity.md"

      - lifecycle: "afterChange"
        trigger: "updateRankingScore"
        description: "Cập nhật rankingScore async sau khi post thay đổi trạng thái/tương tác"
        source: "er-diagram.md#POSTS.ranking_score (feed ranking note)"

    access_control:
      create: ["member"]
      read: ["member", "public"]
      update: ["owner", "admin"]
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m2-content-engine.md#UC08,UC09,UC10"

    assumptions: []

  - slug: "media"
    display_name: "Media"
    payload_collection: "media"
    aggregate_root: true
    fields:
      - name: "filename"
        type: "text"
        required: true
        source: "activity-diagrams/m2-a2-media-handler.md (PayloadCMS Upload collection)"

      - name: "mimeType"
        type: "text"
        required: true
        source: "activity-diagrams/m2-a2-media-handler.md (nén, tối ưu hóa)"

      - name: "filesize"
        type: "number"
        required: true
        source: "activity-diagrams/m2-a2-media-handler.md"

      - name: "url"
        type: "text"
        required: true
        source: "activity-diagrams/m2-a2-media-handler.md (trả về định danh ID)"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md (implied by Payload Upload collection timestamps)"

      - name: "updatedAt"
        type: "date"
        required: true
        source: "er-diagram.md (implied by Payload Upload collection timestamps)"

    behaviors: []

    access_control:
      create: ["member"]
      read: ["public"]
      update: ["owner", "admin"]
      delete: ["owner", "admin"]
      source: "UseCase/use-case-m2-content-engine.md#UC08 (media attachment)"

    assumptions: []

  - slug: "tags"
    display_name: "Tag"
    payload_collection: "tags"
    aggregate_root: true
    fields:
      - name: "name"
        type: "text"
        required: true
        unique: true
        indexed: true
        source: "er-diagram.md (TAGS entity — tag name field)"

      - name: "slug"
        type: "text"
        required: true
        unique: true
        indexed: true
        source: "activity-diagrams/m2-a3-post-integrity.md (extractHashtags — slug normalized)"

      - name: "createdAt"
        type: "date"
        required: true
        source: "er-diagram.md (TAGS — timestamps implied via N:N with posts)"

    behaviors:
      - lifecycle: "beforeChange"
        trigger: "normalizeSlug"
        description: "Convert name → slug (lowercase, remove special chars)"
        source: "activity-diagrams/m2-a3-post-integrity.md"

    access_control:
      create: ["system"]
      read: ["public"]
      update: ["admin"]
      delete: ["admin"]
      source: "UseCase/use-case-m2-content-engine.md#UC08 (hashtag extracted by system)"

    assumptions: []

  # Embedded documents — NOT separate collections
  - slug: "post_tags"
    display_name: "PostTag (Embedded)"
    payload_collection: null
    aggregate_root: false
    embed_in: "posts"
    embed_as: "tags"
    note: "Join table replaced by Post.tags[] (ObjectId[] relationship). No separate MongoDB collection."
    fields: []
    behaviors: []
    access_control: {}
    assumptions: []

  - slug: "post_media"
    display_name: "PostMedia (Embedded)"
    payload_collection: null
    aggregate_root: false
    embed_in: "posts"
    embed_as: "mediaItems"
    note: "Join table replaced by Post.mediaItems[] (ObjectId[] relationship). No separate MongoDB collection."
    fields: []
    behaviors: []
    access_control: {}
    assumptions: []

validation_report:
  total_fields: 23
  fields_with_source: 23
  fields_as_assumption: 0
  unresolved: []
