# ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: 2026-02-20
# To update: re-run generate_yaml.py after editing class-m6-notifications.md and re-approval at IP2.

meta:
  module: "M6"
  module_name: "Notifications & Moderation"
  skill_version: "2.5"
  generated_at: "2026-02-20"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"
    - "Docs/life-2/diagrams/UseCase/use-case-m6-notifications-moderation.md"
    - "Docs/life-2/diagrams/activity-diagrams/m6-a1-sse-dispatcher.md"
    - "Docs/life-2/diagrams/activity-diagrams/m6-a2-report-pipeline.md"
    - "Docs/life-2/diagrams/activity-diagrams/m6-a3-enforcement-action.md"

entities:
  - slug: "notifications"
    display_name: "Notification"
    payload_collection: "notifications"
    aggregate_root: true
    pattern: "Polymorphic Pattern"
    fields:
      - name: "recipientId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#NOTIFICATIONS.recipient_id"

      - name: "actorId"
        type: "relationship"
        relationTo: "users"
        required: false
        source: "er-diagram.md#NOTIFICATIONS.actor_id"
        note: "nullable — system notifications have no actor"

      - name: "type"
        type: "select"
        required: true
        options: ["like", "comment", "follow", "report_update", "system"]
        indexed: true
        source: "er-diagram.md#NOTIFICATIONS.type"

      - name: "entityType"
        type: "select"
        required: true
        options: ["post", "comment", "user", "report"]
        source: "er-diagram.md#NOTIFICATIONS.entity_type"
        pattern: "Polymorphic Pattern"

      - name: "entityId"
        type: "text"
        required: false
        indexed: true
        source: "er-diagram.md#NOTIFICATIONS.entity_id"
        note: "ObjectId as text — polymorphic ref, no FK constraint"
        pattern: "Polymorphic Pattern"

      - name: "isRead"
        type: "boolean"
        required: true
        defaultValue: false
        indexed: true
        source: "er-diagram.md#NOTIFICATIONS.is_read"
        note: "badge counter — index for fast unread count query"

      - name: "readAt"
        type: "date"
        required: false
        source: "er-diagram.md#NOTIFICATIONS.read_at"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#NOTIFICATIONS.created_at"
        note: "sort desc — newest first"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "pushSSE"
        description: "Sau khi tạo Notification, dispatch event qua SSE stream đến recipientId"
        source: "activity-diagrams/m6-a1-sse-dispatcher.md"

    access_control:
      create: ["system"]
      read: ["recipient"]
      update: ["recipient"]
      delete: ["system"]
      source: "UseCase/use-case-m6-notifications-moderation.md#UC21,UC22"

    assumptions: []

  - slug: "reports"
    display_name: "Report"
    payload_collection: "reports"
    aggregate_root: true
    pattern: "Polymorphic Pattern"
    fields:
      - name: "reporterId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#REPORTS.reporter_id"

      - name: "targetType"
        type: "select"
        required: true
        options: ["post", "comment", "user"]
        indexed: true
        source: "er-diagram.md#REPORTS.target_type"
        pattern: "Polymorphic Pattern"

      - name: "targetId"
        type: "text"
        required: true
        indexed: true
        source: "er-diagram.md#REPORTS.target_id"
        note: "ObjectId as text — polymorphic ref, no FK constraint"
        pattern: "Polymorphic Pattern"

      - name: "reason"
        type: "text"
        required: true
        source: "er-diagram.md#REPORTS.reason"

      - name: "status"
        type: "select"
        required: true
        options: ["pending", "resolved", "dismissed"]
        defaultValue: "pending"
        indexed: true
        source: "er-diagram.md#REPORTS.status"

      - name: "resolvedBy"
        type: "relationship"
        relationTo: "users"
        required: false
        source: "er-diagram.md#REPORTS.resolved_by"
        note: "admin who resolved — nullable until resolved"

      - name: "resolvedAt"
        type: "date"
        required: false
        source: "er-diagram.md#REPORTS.resolved_at"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#REPORTS.created_at"
        note: "queue ordering — newest pending first"

    behaviors:
      - lifecycle: "afterChange"
        trigger: "createAuditLog"
        description: "Mỗi thay đổi status Report tạo AuditLog record"
        source: "activity-diagrams/m6-a2-report-pipeline.md (C4 → D2: AuditLogs)"

    access_control:
      create: ["member"]
      read: ["admin", "reporter"]
      update: ["admin"]
      delete: []
      source: "UseCase/use-case-m6-notifications-moderation.md#UC23,UC24"

    assumptions: []

  - slug: "auditLogs"
    display_name: "AuditLog"
    payload_collection: "audit-logs"
    aggregate_root: true
    pattern: "Append-Only Pattern"
    fields:
      - name: "reportId"
        type: "relationship"
        relationTo: "reports"
        required: true
        indexed: true
        source: "er-diagram.md#AUDIT_LOGS.report_id"

      - name: "adminId"
        type: "relationship"
        relationTo: "users"
        required: true
        indexed: true
        source: "er-diagram.md#AUDIT_LOGS.admin_id"

      - name: "action"
        type: "select"
        required: true
        options: ["hide_post", "ban_user", "dismiss_report", "warn_user"]
        source: "er-diagram.md#AUDIT_LOGS.action"

      - name: "reason"
        type: "text"
        required: true
        source: "er-diagram.md#AUDIT_LOGS.reason"

      - name: "createdAt"
        type: "date"
        required: true
        indexed: true
        source: "er-diagram.md#AUDIT_LOGS.created_at"
        note: "chronology index — append-only, immutable"

    behaviors: []

    access_control:
      create: ["system"]
      read: ["admin"]
      update: []
      delete: []
      note: "Append-Only Pattern — update=nobody, delete=nobody. Immutable audit trail."
      source: "UseCase/use-case-m6-notifications-moderation.md#UC24 + activity-diagrams/m6-a2-report-pipeline.md"

    assumptions: []

validation_report:
  total_fields: 21
  fields_with_source: 21
  fields_as_assumption: 0
  unresolved: []
