# Engagement & Connections - Schema Design

> Data Architect Schema cho PayloadCMS/MongoDB từ Contract `Docs/life-2/diagrams/class-diagrams/m4-engagement/class-m4-engagement.yaml`.

## 1. Module Overview
- **Mã hệ thống**: `M4`
- **Mô tả ngắn**: Quản lý thao tác Tương tác (Like, Comment, Share) và Kết nối (Follow/Connections). Các bảng này đều độc lập do tỷ lệ tăng trưởng cực lớn (Hàng tỷ rows), không thể nhúng (embed) vào Root Post hay User.

## 2. Database Design (Collections)

### 2.1 Collection: `comments`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Một post có thể nhận 1 triệu comments, không thể Embed theo Array vì 100% gây sập giới hạn BSON 16MB document. Áp dụng cơ chế reference parentCommentId cho Threaded replies.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `postId` | `relationship` | `true` | Ref qua Posts |
| `authorId` | `relationship` | `true` | Người bình luận |
| `parentCommentId`| `relationship`| `true`| Tùy chọn, tạo comment đa tầng |
| `content` | `text` | `false` | Text Nội dung |
| `status` | `select` | `true` | visible, hidden, deleted |
| `createdAt`| `date` | `true` | Phục vụ sorting |
| `updatedAt`| `date` | `false` | Sẽ chạy Computed Hooks |

### 2.2 Collection: `likes`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Like là event toggle. Rất nhiều, tránh embed. Có unique compound index trên `postId + userId`.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `postId` | `relationship` | `true` | |
| `userId` | `relationship` | `true` | |
| `createdAt`| `date` | `true` | Data |

### 2.3 Collection: `connections`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Đương nhiên User followers không thể lưu vào array vì user nổi tiếng có 10tr follower sẽ chạm 16MB. Có compound index `followerId + followingId`.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `followerId`| `relationship` | `true` | |
| `followingId`| `relationship` | `true` | |
| `status` | `select` | `false` | `active` |
| `createdAt`| `date` | `true` | |

### 2.4 Collection: `shares`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Ghi nhận Audit record, shareType có thể là báo copy link, hoặc repost (kèm id Post mới sinh ra).
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `postId` | `relationship` | `true` | Bài gốc |
| `userId` | `relationship` | `true` | Người Share |
| `shareType`| `select` | `true` | copy_link, repost |
| `sharedPostId`| `relationship`| `false`| Null nếu ko repost |
| `createdAt`| `date` | `true` | |

---
*Generated by schema-design-analyst AI Agent.*
