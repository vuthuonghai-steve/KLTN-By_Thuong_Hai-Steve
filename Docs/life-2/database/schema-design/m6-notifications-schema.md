# Notifications & Moderation - Schema Design

> Data Architect Schema cho PayloadCMS/MongoDB từ Contract `Docs/life-2/diagrams/class-diagrams/m6-notifications-moderation/class-m6-notifications.yaml`.

## 1. Module Overview
- **Mã hệ thống**: `M6`
- **Mô tả ngắn**: Quản lý Thông báo Local & Realtime, Report lạm dụng và Audit Logs (ghi dấu vết tác vụ Admin).

## 2. Database Design (Collections)

### 2.1 Collection: `notifications`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Aggregate độc lập với khối lượng record khổng lồ (bắn mỗi giây). Cần đánh index `recipientId + isRead` để truy xuất batch siêu tốc đếm unread badge.
- **Pattern**: Polymorphic Pattern — Dùng biến `entityType` và `entityId` format Text (ko dùng ràng buộc Relation FK) để reference vô số loại entity (posts, comments, users) mà không lo lỗi khi collection/bài post bị xóa.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `recipientId` | `relationship` | `true` | Ai nhận |
| `actorId` | `relationship` | `false`| Ai gây ra (Tùy chọn) |
| `type` | `select` | `true` | like, comment, follow, report_update, system |
| `entityType` | `select` | `false`| post, comment, user, report |
| `entityId` | `text` | `true` | Polymorphic ObjectId as Text |
| `isRead` | `checkbox` | `true` | Flag unread |
| `readAt` | `date` | `false`| Tracking lúc đọc |
| `createdAt` | `date` | `true` | Sort |

### 2.2 Collection: `reports`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Bảng lưu trữ báo cáo vi phạm, cho admin xử lý và cũng apply Polymorphic pattern như Notifications.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `reporterId`| `relationship` | `true` | Ai tố cáo |
| `targetType`| `select` | `true` | post, comment, user |
| `targetId`  | `text` | `true` | Polymorphic ID text |
| `reason` | `text` | `false`| Lý do viết tay |
| `status` | `select` | `true` | pending, resolved, dismissed |
| `resolvedBy`| `relationship` | `false`| Ai xử lý (admin) |
| `resolvedAt`| `date` | `false`| Khi nào |
| `createdAt` | `date` | `true` | Queue by time |

### 2.3 Collection: `auditLogs`
- **Type**: `Aggregate Root (Reference)`
- **Reason**: Audit Log sử dụng *Append-Only Pattern* (100% không cho phép update hay delete với bất kì role nào), là nơi lưu giữ vết vĩnh viễn hành động của admin.
- **Fields List**:
| Field Name | Type | Index? | Mô tả / Range |
|------------|------|--------|---------------|
| `reportId` | `relationship` | `true` | Issue xử lý |
| `adminId` | `relationship` | `true` | Admin trực ca |
| `action` | `select` | `false`| hide_post, ban_user, dismiss_report, warn_user |
| `reason` | `text` | `false`| Lời nhắn / Bằng chứng |
| `createdAt`| `date` | `true` | Thời gian bất biến |

---
*Generated by schema-design-analyst AI Agent.*
