# class-diagram-analyst — Validation Checklist

> **Usage**: Đọc khi khởi động (Tầng 1 Mandatory). Kiểm tra sau mỗi entity VÀ sau mỗi phase.
> **Source**: design.md §2.3 Guardrails, §3 loop/

---

## Per-Field Checks (sau mỗi field được khai báo)

- [ ] **[G1] Source Citation**: Field có `source:` không rỗng? (VD: `er-diagram.md#USERS.email`)
  - ✅ PASS: source trỏ về file cụ thể + section hoặc line
  - ❌ BLOCK: `source: ""` hoặc thiếu key `source` → KHÔNG ghi file
  - ⚠️ WARN: source là `[FROM_CONTEXT]` hoặc `[ASSUMPTION]` → báo cáo tại IP1

- [ ] **[G2] Type Whitelist**: Field type có nằm trong `allowed_field_types`?
  ```
  Allowed: text, email, number, boolean, date, select, json, richText,
           relationship, upload, array, group, point, blocks
  NOT Allowed: string, int, float, object, timestamp, varchar
  ```
  - ✅ PASS: type nằm trong list
  - ❌ BLOCK: type không hợp lệ → throw error, KHÔNG tạo YAML

---

## Per-Entity Checks (sau mỗi entity hoàn thành)

- [ ] **[G3] Slug Unique**: Entity slug có unique trong file YAML không?
  - ✅ PASS: không có duplicate slug
  - ❌ BLOCK: trùng slug → throw error

- [ ] **[G4] Aggregate Root Classification**: Entity được phân loại đúng Decision Tree?
  ```
  Q1: Nhiều FK trỏ vào? → Root
  Q2: Có timestamps riêng? → Root
  Q3: Query độc lập (không qua parent)? → Root
  Q4: Size có thể vượt 16MB BSON? → Root
  Tất cả NO → Embedded
  ```
  - ✅ PASS: phân loại khớp với `module-map.yaml`
  - ⚠️ ALERT: phân loại không khớp → báo cáo tại IP1, chờ user xác nhận

- [ ] **Relationship Fields**: `relationship` type có khai báo `relationTo` không?
  - ✅ PASS: `relationTo: 'collection_name'` hoặc `relationTo: ['col1', 'col2']`
  - ❌ BLOCK: thiếu `relationTo` → lỗi runtime trong Payload

- [ ] **Computed Counter Fields**: Counter field có `admin.readOnly: true` không?
  - ✅ PASS: `admin: { readOnly: true }`
  - ⚠️ WARN: thiếu readOnly → counter có thể bị edit thủ công

---

## Per-Phase Checks

### Phase A (Extract) đã done khi:
- [ ] Entity list từ `module-map.yaml` đã được load
- [ ] Field dict từ `er-diagram.md` đã được extract cho mỗi entity
- [ ] Không có entity nào bị bỏ sót

### Phase B (Cross-Reference) đã done khi:
- [ ] `activity-diagrams/mX-*.md` đã được scan → behaviors[] đã có
- [ ] `UseCase/use-case-mX-*.md` đã được scan → access_control[] đã có
- [ ] VỚI M6: `notifications` phải có Polymorphic Pattern được ghi nhận

### Phase C (Classify) đã done khi:
- [ ] Mọi entity đã có classification (Root/Embedded/ValueObject)
- [ ] `post_tags` và `post_media` được đánh dấu `embed_in: posts`
- [ ] M3 FeedQuery được đánh dấu `<<ValueObject>>`, `aggregate_root: false`

### Phase D (Gen .md) đã done khi:
- [ ] Mermaid block hợp lệ (chạy qua renderers không lỗi)
- [ ] Traceability Table có đủ rows cho mọi field
- [ ] Assumption Register có đủ entries cho mọi `[ASSUMPTION]` field
- [ ] Lưu file tại đúng path: `Docs/life-2/diagrams/class-diagrams/mX-name/class-mX.md`

### Phase E (Gen .yaml) đã done khi:
- [ ] LOCKED header đầu file: `# ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.`
- [ ] `meta` section đầy đủ: module, skill_version, generated_at, sources_consumed
- [ ] Mọi entity có `slug`, `aggregate_root`, `fields[]`, `behaviors[]`, `access_control`
- [ ] `validation_report` có total_fields + fields_with_source

### Phase F (Validate) đã done khi:
- [ ] `validate_contract.py` chạy xong, output = PASS
- [ ] Không còn violation nào trong output
- [ ] Warnings đã được review (không nhất thiết phải fix nếu acceptable)

---

## YAML Header Check (bắt buộc)

- [ ] **[G5] LOCKED Header**: YAML file đầu tiên có dòng:
  ```
  # ⚠️ LOCKED CONTRACT — DO NOT EDIT MANUALLY.
  # Generated by Skill 2.5 (class-diagram-analyst).
  ```
  - ✅ PASS: header tồn tại
  - ⚠️ WARN: thiếu header → ai đó sẽ dễ nhầm file này có thể edit

---

## Interaction Points Gate (BẮT BUỘC — KHÔNG bỏ qua)

- [ ] **IP0**: Nếu input mơ hồ → ĐÃ hỏi và user ĐÃ xác nhận scope TRƯỚC khi Phase A
- [ ] **IP1**: ĐÃ trình bày entity list + classification → user ĐÃ xác nhận TRƯỚC Phase D
- [ ] **IP2**: ĐÃ trình bày class-mX.md → user ĐÃ approve TRƯỚC Phase E
- [ ] **IP3**: ĐÃ báo cáo validation result → user ĐÃ acknowledge TRƯỚC khi update index.md

> ⚠️ **CỨNG**: Bỏ qua bất kỳ IP nào = vi phạm Guardrail G6 = BLOCK.

---

## Index.md Update Check

- [ ] Module `✅ Ready` trong `Docs/life-2/diagrams/class-diagrams/index.md` **CHỈ** được ghi khi:
  1. IP3 đã pass
  2. validate_contract.py output = PASS
  3. User đã acknowledge tại IP3
