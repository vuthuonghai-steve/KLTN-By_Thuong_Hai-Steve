# Test Case: validate_contract.py ‚Äî PASS & FAIL Scenarios

> **Purpose**: Ki·ªÉm tra validate_contract.py ho·∫°t ƒë·ªông ƒë√∫ng theo 5 checks c·ªßa Guardrails
> **Source**: design.md ¬ß2.3, ¬ß4 Task 4.2

---

## Test 1: YAML h·ª£p l·ªá ‚Üí Expected PASS

### Input YAML (valid-contract.yaml)

```yaml
# ‚ö†Ô∏è LOCKED CONTRACT ‚Äî DO NOT EDIT MANUALLY.
# Generated by Skill 2.5 (class-diagram-analyst). Last updated: 2026-02-20

meta:
  module: "M1"
  module_name: "Auth & Profile"
  skill_version: "2.5"
  generated_at: "2026-02-20"
  sources_consumed:
    - "Docs/life-2/diagrams/er-diagram.md"

entities:
  - slug: "users"
    display_name: "User"
    payload_collection: "users"
    aggregate_root: true
    fields:
      - name: "email"
        type: "email"
        required: true
        unique: true
        source: "er-diagram.md#USERS.email"

      - name: "username"
        type: "text"
        required: true
        source: "er-diagram.md#USERS.username"

      - name: "role"
        type: "select"
        required: true
        options: ["user", "admin", "moderator"]
        source: "er-diagram.md#USERS.role"

    behaviors: []
    access_control:
      create: ["anyone"]
      read: ["owner", "admin"]
    assumptions: []

validation_report:
  total_fields: 3
  fields_with_source: 3
  fields_as_assumption: 0
  unresolved: []
```

### Expected Command

```bash
python scripts/validate_contract.py valid-contract.yaml
```

### Expected Output

```
============================================================
YAML Contract Validation Report
File: valid-contract.yaml
============================================================
Stats:
  Total entities : 1
  Total fields   : 3
  With source    : 3
  Assumptions    : 0
============================================================

============================================================
‚úÖ PASS ‚Äî Contract h·ª£p l·ªá
```

### Expected Exit Code: `0`

---

## Test 2: Field thi·∫øu source ‚Üí Expected FAIL [G1]

### Input YAML (missing-source.yaml)

```yaml
# ‚ö†Ô∏è LOCKED CONTRACT ‚Äî DO NOT EDIT MANUALLY.

meta:
  module: "M1"
  module_name: "Auth & Profile"
  skill_version: "2.5"

entities:
  - slug: "users"
    display_name: "User"
    aggregate_root: true
    fields:
      - name: "email"
        type: "email"
        required: true
        source: "er-diagram.md#USERS.email"

      - name: "badField"
        type: "text"
        required: false
        source: ""  # ‚Üê EMPTY SOURCE ‚Äî vi ph·∫°m G1

      - name: "noSourceField"
        type: "text"
        required: false
        # ‚Üê MISSING source key ‚Äî vi ph·∫°m G1

validation_report:
  total_fields: 3
  fields_with_source: 1
  fields_as_assumption: 0
  unresolved: []
```

### Expected Command

```bash
python scripts/validate_contract.py missing-source.yaml
```

### Expected Output

```
============================================================
YAML Contract Validation Report
File: missing-source.yaml
============================================================
Stats:
  Total entities : 1
  Total fields   : 3
  With source    : 1
  Assumptions    : 0
============================================================

üî¥ VIOLATIONS (2):
  ‚úó [G1-CITATION] Entity 'users', field 'badField': thi·∫øu source citation
  ‚úó [G1-CITATION] Entity 'users', field 'noSourceField': thi·∫øu source citation

============================================================
‚ùå FAIL ‚Äî Contract c√≥ violations c·∫ßn fix tr∆∞·ªõc khi lock
```

### Expected Exit Code: `1`

---

## Test 3: Field type kh√¥ng h·ª£p l·ªá ‚Üí Expected FAIL [G2]

### Input YAML (invalid-types.yaml)

```yaml
# ‚ö†Ô∏è LOCKED CONTRACT ‚Äî DO NOT EDIT MANUALLY.

meta:
  module: "M2"
  module_name: "Content Engine"
  skill_version: "2.5"

entities:
  - slug: "posts"
    display_name: "Post"
    aggregate_root: true
    fields:
      - name: "title"
        type: "string"     # ‚Üê SAI ‚Äî ph·∫£i l√† 'text'
        required: true
        source: "er-diagram.md#POSTS.title"

      - name: "likeCount"
        type: "int"        # ‚Üê SAI ‚Äî ph·∫£i l√† 'number'
        required: false
        source: "er-diagram.md#POSTS.like_count"

      - name: "meta"
        type: "object"     # ‚Üê SAI ‚Äî ph·∫£i l√† 'group'
        required: false
        source: "er-diagram.md#POSTS.meta"

      - name: "content"
        type: "richText"   # ‚Üê ƒê√öNG
        required: true
        source: "er-diagram.md#POSTS.content"

validation_report:
  total_fields: 4
  fields_with_source: 4
  fields_as_assumption: 0
  unresolved: []
```

### Expected Command

```bash
python scripts/validate_contract.py invalid-types.yaml
```

### Expected Output

```
============================================================
YAML Contract Validation Report
File: invalid-types.yaml
============================================================
Stats:
  Total entities : 1
  Total fields   : 4
  With source    : 4
  Assumptions    : 0
============================================================

üî¥ VIOLATIONS (3):
  ‚úó [G2-TYPE] Entity 'posts', field 'title': type 'string' kh√¥ng h·ª£p l·ªá. Allowed: [text, email, ...]
  ‚úó [G2-TYPE] Entity 'posts', field 'likeCount': type 'int' kh√¥ng h·ª£p l·ªá. Allowed: [text, email, ...]
  ‚úó [G2-TYPE] Entity 'posts', field 'meta': type 'object' kh√¥ng h·ª£p l·ªá. Allowed: [text, email, ...]

============================================================
‚ùå FAIL ‚Äî Contract c√≥ violations c·∫ßn fix tr∆∞·ªõc khi lock
```

### Expected Exit Code: `1`

---

## Test 4: Duplicate slug ‚Üí Expected FAIL [G3]

### Input YAML (duplicate-slug.yaml)

```yaml
# ‚ö†Ô∏è LOCKED CONTRACT ‚Äî DO NOT EDIT MANUALLY.

meta:
  module: "M4"
  module_name: "Engagement"
  skill_version: "2.5"

entities:
  - slug: "comments"
    display_name: "Comment"
    aggregate_root: true
    fields:
      - name: "content"
        type: "text"
        source: "er-diagram.md#COMMENTS.content"

  - slug: "comments"   # ‚Üê DUPLICATE SLUG ‚Äî vi ph·∫°m G3
    display_name: "CommentDuplicate"
    aggregate_root: true
    fields:
      - name: "body"
        type: "text"
        source: "er-diagram.md#COMMENTS.body"

validation_report:
  total_fields: 2
  fields_with_source: 2
  fields_as_assumption: 0
  unresolved: []
```

### Expected Output

```
üî¥ VIOLATIONS (1):
  ‚úó [G3-SLUG] Duplicate entity slug: 'comments'

‚ùå FAIL ‚Äî Contract c√≥ violations c·∫ßn fix tr∆∞·ªõc khi lock
```

### Expected Exit Code: `1`

---

## Test 5: Thi·∫øu LOCKED header ‚Üí Expected WARNING

### Input: YAML h·ª£p l·ªá v·ªÅ types + source, nh∆∞ng kh√¥ng c√≥ LOCKED header comment

### Expected Output

```
‚ö†Ô∏è  WARNINGS (1):
  ! [G5-LOCK] YAML Contract thi·∫øu LOCKED header comment.

‚úÖ PASS ‚Äî Contract h·ª£p l·ªá
```

*(PASS v√¨ warnings kh√¥ng block ‚Äî ch·ªâ FAIL khi c√≥ violations)*

### Expected Exit Code: `0`

### V·ªõi `--strict` flag:

```bash
python scripts/validate_contract.py no-header.yaml --strict
```

### Expected Exit Code: `1` (warnings ‚Üí violations trong strict mode)

---

## Ch·∫°y to√†n b·ªô test suite

```bash
cd .agent/skills/class-diagram-analyst

# Setup
pip install -r scripts/requirements.txt

# Test 1: PASS
python scripts/validate_contract.py loop/test-cases/samples/valid-contract.yaml && echo "Test 1: PASS ‚úÖ"

# Test 2: FAIL [G1]
python scripts/validate_contract.py loop/test-cases/samples/missing-source.yaml; [ $? -eq 1 ] && echo "Test 2: PASS ‚úÖ" || echo "Test 2: FAIL ‚ùå"

# Test 3: FAIL [G2]
python scripts/validate_contract.py loop/test-cases/samples/invalid-types.yaml; [ $? -eq 1 ] && echo "Test 3: PASS ‚úÖ" || echo "Test 3: FAIL ‚ùå"

# Test 4: FAIL [G3]
python scripts/validate_contract.py loop/test-cases/samples/duplicate-slug.yaml; [ $? -eq 1 ] && echo "Test 4: PASS ‚úÖ" || echo "Test 4: FAIL ‚ùå"
```
